{"version":3,"names":["common_1","cov_26l072sr82","s","require","mongoose_1","mongoose_2","news_release_schema_1","shared_1","cron","__importStar","PublicationSchedulerService","newsReleaseModel","scheduledTask","constructor","f","onModuleInit","schedule","checkAndPublishScheduledReleases","onModuleDestroy","b","stop","now","Date","scheduledReleases","find","status","NewsReleaseStatus","SCHEDULED","scheduledFor","$lte","isDeleted","release","findByIdAndUpdate","_id","PUBLISHED","publishedAt","$inc","version","console","log","slug","error","schedulePublication","releaseId","new","cancelScheduledPublication","DRAFT","$unset","exports","__decorate","Injectable","__param","InjectModel","NewsRelease","name","Model"],"sources":["/home/luisneto98/Documentos/Code/monorepo-vtex/apps/api/src/modules/news-releases/services/publication-scheduler.service.ts"],"sourcesContent":["import { Injectable, OnModuleInit, OnModuleDestroy } from '@nestjs/common';\nimport { InjectModel } from '@nestjs/mongoose';\nimport { Model } from 'mongoose';\nimport { NewsRelease, NewsReleaseDocument } from '../schemas/news-release.schema';\nimport { NewsReleaseStatus } from '@vtexday26/shared';\nimport * as cron from 'node-cron';\n\n@Injectable()\nexport class PublicationSchedulerService implements OnModuleInit, OnModuleDestroy {\n  private scheduledTask: cron.ScheduledTask;\n\n  constructor(\n    @InjectModel(NewsRelease.name)\n    private newsReleaseModel: Model<NewsReleaseDocument>,\n  ) {}\n\n  onModuleInit() {\n    this.scheduledTask = cron.schedule('*/1 * * * *', () => {\n      this.checkAndPublishScheduledReleases();\n    });\n  }\n\n  onModuleDestroy() {\n    if (this.scheduledTask) {\n      this.scheduledTask.stop();\n    }\n  }\n\n  async checkAndPublishScheduledReleases(): Promise<void> {\n    try {\n      const now = new Date();\n\n      const scheduledReleases = await this.newsReleaseModel.find({\n        status: NewsReleaseStatus.SCHEDULED,\n        scheduledFor: { $lte: now },\n        isDeleted: false,\n      });\n\n      for (const release of scheduledReleases) {\n        await this.newsReleaseModel.findByIdAndUpdate(release._id, {\n          status: NewsReleaseStatus.PUBLISHED,\n          publishedAt: now,\n          $inc: { version: 1 },\n        });\n\n        console.log(`Published scheduled news release: ${release.slug}`);\n      }\n    } catch (error) {\n      console.error('Error checking scheduled releases:', error);\n    }\n  }\n\n  async schedulePublication(releaseId: string, scheduledFor: Date): Promise<NewsReleaseDocument> {\n    return this.newsReleaseModel.findByIdAndUpdate(\n      releaseId,\n      {\n        status: NewsReleaseStatus.SCHEDULED,\n        scheduledFor,\n        $inc: { version: 1 },\n      },\n      { new: true },\n    );\n  }\n\n  async cancelScheduledPublication(releaseId: string): Promise<NewsReleaseDocument> {\n    return this.newsReleaseModel.findByIdAndUpdate(\n      releaseId,\n      {\n        status: NewsReleaseStatus.DRAFT,\n        $unset: { scheduledFor: 1 },\n        $inc: { version: 1 },\n      },\n      { new: true },\n    );\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}