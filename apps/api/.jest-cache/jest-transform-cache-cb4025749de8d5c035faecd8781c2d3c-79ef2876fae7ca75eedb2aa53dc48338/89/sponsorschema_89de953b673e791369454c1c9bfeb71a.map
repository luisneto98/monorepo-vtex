{"file":"/home/luisneto98/Documentos/Code/monorepo-vtex/apps/api/src/modules/sponsors/schemas/sponsor.schema.ts","mappings":"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","names":[],"sources":["/home/luisneto98/Documentos/Code/monorepo-vtex/apps/api/src/modules/sponsors/schemas/sponsor.schema.ts"],"sourcesContent":["import { Prop, Schema, SchemaFactory } from '@nestjs/mongoose';\nimport { Document, Schema as MongooseSchema } from 'mongoose';\nimport { Sponsor as ISponsor, SponsorSocialLinks } from '@shared/types/sponsor.types';\n\nexport type SponsorDocument = Sponsor & Document;\n\n@Schema({ _id: false })\nclass Description {\n  @Prop({\n    required: true,\n    maxlength: 500,\n    trim: true,\n  })\n  'pt-BR': string;\n\n  @Prop({\n    required: true,\n    maxlength: 500,\n    trim: true,\n  })\n  'en': string;\n}\n\n@Schema({ _id: false })\nclass SocialLinks implements SponsorSocialLinks {\n  @Prop({\n    match: /^https?:\\/\\/(www\\.)?linkedin\\.com\\/.+/,\n  })\n  linkedin?: string;\n\n  @Prop({\n    match: /^https?:\\/\\/(www\\.)?instagram\\.com\\/.+/,\n  })\n  instagram?: string;\n\n  @Prop({\n    match: /^https?:\\/\\/(www\\.)?facebook\\.com\\/.+/,\n  })\n  facebook?: string;\n}\n\n@Schema({ timestamps: true, collection: 'Sponsor' })\nexport class Sponsor implements Omit<ISponsor, '_id'> {\n  @Prop({\n    required: true,\n    unique: true,\n    maxlength: 100,\n    trim: true,\n  })\n  name: string;\n\n  @Prop({\n    required: true,\n    unique: true,\n    lowercase: true,\n    trim: true,\n    match: /^[a-z0-9-]+$/,\n  })\n  slug: string;\n\n  @Prop({\n    type: Description,\n    required: true,\n  })\n  description: {\n    'pt-BR': string;\n    en: string;\n  };\n\n  @Prop({\n    match: /^https?:\\/\\/.+/,\n  })\n  logoUrl?: string;\n\n  @Prop({\n    type: MongooseSchema.Types.ObjectId,\n    ref: 'SponsorTier',\n    required: true,\n    index: true,\n  })\n  tier: string;\n\n  @Prop({\n    required: true,\n    min: 1,\n  })\n  orderInTier: number;\n\n  @Prop({\n    match: /^https?:\\/\\/.+/,\n  })\n  websiteUrl?: string;\n\n  @Prop({\n    maxlength: 100,\n    trim: true,\n  })\n  standLocation?: string;\n\n  @Prop({\n    required: true,\n    lowercase: true,\n    trim: true,\n    match: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/,\n  })\n  adminEmail: string;\n\n  @Prop({\n    lowercase: true,\n    trim: true,\n    match: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/,\n  })\n  contactEmail?: string;\n\n  @Prop({\n    type: SocialLinks,\n    default: {},\n  })\n  socialLinks?: SponsorSocialLinks;\n\n  @Prop({\n    min: 0,\n  })\n  maxPosts?: number;\n\n  @Prop({\n    default: 0,\n    min: 0,\n  })\n  postsUsed: number;\n\n  @Prop({\n    type: [String],\n    default: [],\n  })\n  tags: string[];\n\n  @Prop({\n    default: true,\n    index: true,\n  })\n  isVisible: boolean;\n\n  @Prop({\n    type: Date,\n    default: null,\n  })\n  deletedAt?: Date;\n\n  @Prop({\n    type: MongooseSchema.Types.ObjectId,\n    ref: 'User',\n  })\n  deletedBy?: MongooseSchema.Types.ObjectId;\n\n  @Prop({\n    type: String,\n  })\n  deleteReason?: string;\n}\n\nexport const SponsorSchema = SchemaFactory.createForClass(Sponsor);\n\n// Indexes\nSponsorSchema.index({ tier: 1, orderInTier: 1 });\nSponsorSchema.index({ slug: 1 });\nSponsorSchema.index({ isVisible: 1 });\nSponsorSchema.index({ deletedAt: 1 });\nSponsorSchema.index({ tags: 1 });\nSponsorSchema.index({ name: 'text', 'description.pt-BR': 'text', 'description.en': 'text' });\n\n// Composite index for public API queries (optimizes {isVisible: true, deletedAt: null} pattern)\nSponsorSchema.index({ isVisible: 1, deletedAt: 1, tier: 1, orderInTier: 1 });\n\n// Pre-save middleware for data normalization\nSponsorSchema.pre('save', function (next) {\n  if (this.name) {\n    this.name = this.name.trim();\n  }\n  if (this.slug) {\n    this.slug = this.slug.toLowerCase().trim();\n  }\n  if (this.adminEmail) {\n    this.adminEmail = this.adminEmail.toLowerCase().trim();\n  }\n  if (this.contactEmail) {\n    this.contactEmail = this.contactEmail.toLowerCase().trim();\n  }\n  if (this.standLocation) {\n    this.standLocation = this.standLocation.trim();\n  }\n  if (this.description) {\n    if (this.description['pt-BR']) {\n      this.description['pt-BR'] = this.description['pt-BR'].trim();\n    }\n    if (this.description['en']) {\n      this.description['en'] = this.description['en'].trim();\n    }\n  }\n  if (this.tags && Array.isArray(this.tags)) {\n    this.tags = this.tags.map((tag) => tag.toLowerCase().trim());\n  }\n  next();\n});\n\n// Validation middleware\nSponsorSchema.pre('save', function (next) {\n  if (this.maxPosts !== undefined && this.postsUsed > this.maxPosts) {\n    next(new Error('Posts used cannot exceed max posts limit'));\n    return;\n  }\n  next();\n});\n\n// Virtual fields\nSponsorSchema.virtual('postsRemaining').get(function () {\n  if (this.maxPosts !== undefined) {\n    return Math.max(0, this.maxPosts - this.postsUsed);\n  }\n  return null;\n});\n\nSponsorSchema.virtual('hasReachedPostLimit').get(function () {\n  if (this.maxPosts !== undefined) {\n    return this.postsUsed >= this.maxPosts;\n  }\n  return false;\n});\n\n// Schema methods\nSponsorSchema.methods['getLocalizedDescription'] = function (language: 'pt-BR' | 'en'): string {\n  return this['description'][language] || this['description']['pt-BR'];\n};\n\nSponsorSchema.methods['canCreatePost'] = function (): boolean {\n  if (this['maxPosts'] === undefined) {\n    return true;\n  }\n  return this['postsUsed'] < this['maxPosts'];\n};\n\nSponsorSchema.methods['incrementPostCount'] = function (): void {\n  this['postsUsed'] = (this['postsUsed'] || 0) + 1;\n};\n"],"version":3}