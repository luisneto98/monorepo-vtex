9ac93532a85d3cafc0f28f6dd71cbfe1
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const encryption_util_1 = require("../../../../src/common/utils/encryption.util");
describe('Encryption Utilities', () => {
    const testKey = 'test-encryption-key-32-bytes!!';
    const originalEnv = process.env['ENCRYPTION_KEY'];
    beforeAll(() => {
        process.env['ENCRYPTION_KEY'] = testKey;
    });
    afterAll(() => {
        process.env['ENCRYPTION_KEY'] = originalEnv;
    });
    describe('encrypt', () => {
        it('should encrypt a string successfully', () => {
            const plaintext = 'my-device-token-12345';
            const encrypted = encryption_util_1.EncryptionUtil.encrypt(plaintext);
            expect(encrypted).toBeDefined();
            expect(encrypted).not.toBe(plaintext);
            expect(encrypted).toContain(':'); // Should have IV separator
        });
        it('should produce different ciphertext for same input (due to random IV)', () => {
            const plaintext = 'same-token';
            const encrypted1 = encryption_util_1.EncryptionUtil.encrypt(plaintext);
            const encrypted2 = encryption_util_1.EncryptionUtil.encrypt(plaintext);
            expect(encrypted1).not.toBe(encrypted2);
        });
        it('should handle empty string', () => {
            const encrypted = encryption_util_1.EncryptionUtil.encrypt('');
            expect(encrypted).toBe('');
        });
        it('should handle long strings', () => {
            const longString = 'a'.repeat(1000);
            const encrypted = encryption_util_1.EncryptionUtil.encrypt(longString);
            expect(encrypted).toBeDefined();
            expect(encryption_util_1.EncryptionUtil.decrypt(encrypted)).toBe(longString);
        });
        it('should handle unicode characters', () => {
            const unicode = 'OlÃ¡ mundo! ä½ å¥½ä¸–ç•Œ ðŸ”';
            const encrypted = encryption_util_1.EncryptionUtil.encrypt(unicode);
            expect(encryption_util_1.EncryptionUtil.decrypt(encrypted)).toBe(unicode);
        });
        it('should handle special characters', () => {
            const special = '!@#$%^&*()_+-=[]{}|;:,.<>?';
            const encrypted = encryption_util_1.EncryptionUtil.encrypt(special);
            expect(encryption_util_1.EncryptionUtil.decrypt(encrypted)).toBe(special);
        });
    });
    describe('decrypt', () => {
        it('should decrypt encrypted text successfully', () => {
            const plaintext = 'FCM-token-abc123xyz';
            const encrypted = encryption_util_1.EncryptionUtil.encrypt(plaintext);
            const decrypted = encryption_util_1.EncryptionUtil.decrypt(encrypted);
            expect(decrypted).toBe(plaintext);
        });
        it('should handle multiple encrypt/decrypt cycles', () => {
            const original = 'device-token-value';
            const encrypted1 = encryption_util_1.EncryptionUtil.encrypt(original);
            const decrypted1 = encryption_util_1.EncryptionUtil.decrypt(encrypted1);
            expect(decrypted1).toBe(original);
            const encrypted2 = encryption_util_1.EncryptionUtil.encrypt(decrypted1);
            const decrypted2 = encryption_util_1.EncryptionUtil.decrypt(encrypted2);
            expect(decrypted2).toBe(original);
        });
        it('should throw error for invalid ciphertext format', () => {
            expect(() => encryption_util_1.EncryptionUtil.decrypt('invalid-format')).toThrow();
        });
        it('should throw error for malformed encrypted data', () => {
            expect(() => encryption_util_1.EncryptionUtil.decrypt('abc:def')).toThrow();
        });
        it('should return empty string for empty input', () => {
            expect(encryption_util_1.EncryptionUtil.decrypt('')).toBe('');
        });
        it('should handle base64 encoded data correctly', () => {
            const token = 'ey123.abc456.xyz789'; // JWT-like token
            const encrypted = encryption_util_1.EncryptionUtil.encrypt(token);
            const decrypted = encryption_util_1.EncryptionUtil.decrypt(encrypted);
            expect(decrypted).toBe(token);
        });
    });
    describe('encryption security', () => {
        it('should use different IV for each encryption', () => {
            const plaintext = 'test-token';
            const encrypted1 = encryption_util_1.EncryptionUtil.encrypt(plaintext);
            const encrypted2 = encryption_util_1.EncryptionUtil.encrypt(plaintext);
            const iv1 = encrypted1.split(':')[0];
            const iv2 = encrypted2.split(':')[0];
            expect(iv1).not.toBe(iv2);
        });
        it('should produce ciphertext that looks random', () => {
            const plaintext = 'aaaaaaaaaa';
            const encrypted = encryption_util_1.EncryptionUtil.encrypt(plaintext);
            const ciphertext = encrypted.split(':')[1];
            // Base64 ciphertext should not contain the plaintext
            expect(Buffer.from(ciphertext, 'base64').toString()).not.toContain('aaaaaaaaaa');
        });
        it('should require correct key for decryption', () => {
            const plaintext = 'secret-token';
            const encrypted = encryption_util_1.EncryptionUtil.encrypt(plaintext);
            // Change the encryption key
            process.env['ENCRYPTION_KEY'] = 'wrong-key-32-bytes-length!!!';
            expect(() => encryption_util_1.EncryptionUtil.decrypt(encrypted)).toThrow();
            // Restore correct key
            process.env['ENCRYPTION_KEY'] = testKey;
        });
        it('should handle tampering with ciphertext', () => {
            const plaintext = 'original-token';
            const encrypted = encryption_util_1.EncryptionUtil.encrypt(plaintext);
            // Tamper with the ciphertext
            const parts = encrypted.split(':');
            const tamperedCiphertext = parts[0] + ':' + parts[1] + ':' + parts[2].slice(0, -4) + 'XXXX';
            expect(() => encryption_util_1.EncryptionUtil.decrypt(tamperedCiphertext)).toThrow();
        });
        it('should handle tampering with IV', () => {
            const plaintext = 'original-token';
            const encrypted = encryption_util_1.EncryptionUtil.encrypt(plaintext);
            // Tamper with the IV
            const parts = encrypted.split(':');
            const tamperedIv = parts[0].slice(0, -4) + 'YYYY';
            const tampered = tamperedIv + ':' + parts[1] + ':' + parts[2];
            expect(() => encryption_util_1.EncryptionUtil.decrypt(tampered)).toThrow();
        });
    });
    describe('edge cases', () => {
        it('should handle very short strings', () => {
            const short = 'a';
            const encrypted = encryption_util_1.EncryptionUtil.encrypt(short);
            expect(encryption_util_1.EncryptionUtil.decrypt(encrypted)).toBe(short);
        });
        it('should handle strings with newlines', () => {
            const multiline = 'line1\nline2\nline3';
            const encrypted = encryption_util_1.EncryptionUtil.encrypt(multiline);
            expect(encryption_util_1.EncryptionUtil.decrypt(encrypted)).toBe(multiline);
        });
        it('should handle strings with tabs', () => {
            const tabbed = 'col1\tcol2\tcol3';
            const encrypted = encryption_util_1.EncryptionUtil.encrypt(tabbed);
            expect(encryption_util_1.EncryptionUtil.decrypt(encrypted)).toBe(tabbed);
        });
        it('should handle JSON strings', () => {
            const json = JSON.stringify({ token: 'abc123', platform: 'ios' });
            const encrypted = encryption_util_1.EncryptionUtil.encrypt(json);
            expect(encryption_util_1.EncryptionUtil.decrypt(encrypted)).toBe(json);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvbHVpc25ldG85OC9Eb2N1bWVudG9zL0NvZGUvbW9ub3JlcG8tdnRleC9hcHBzL2FwaS90ZXN0cy91bml0L2NvbW1vbi91dGlscy9lbmNyeXB0aW9uLnV0aWwuc3BlYy50cyIsIm1hcHBpbmdzIjoiOztBQUFBLGtGQUE4RTtBQUU5RSxRQUFRLENBQUMsc0JBQXNCLEVBQUUsR0FBRyxFQUFFO0lBQ3BDLE1BQU0sT0FBTyxHQUFHLGdDQUFnQyxDQUFDO0lBQ2pELE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUVsRCxTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ2IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLE9BQU8sQ0FBQztJQUMxQyxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxHQUFHLEVBQUU7UUFDWixPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsV0FBVyxDQUFDO0lBQzlDLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLFNBQVMsRUFBRSxHQUFHLEVBQUU7UUFDdkIsRUFBRSxDQUFDLHNDQUFzQyxFQUFFLEdBQUcsRUFBRTtZQUM5QyxNQUFNLFNBQVMsR0FBRyx1QkFBdUIsQ0FBQztZQUMxQyxNQUFNLFNBQVMsR0FBRyxnQ0FBYyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUVwRCxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDaEMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDdEMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLDJCQUEyQjtRQUMvRCxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyx1RUFBdUUsRUFBRSxHQUFHLEVBQUU7WUFDL0UsTUFBTSxTQUFTLEdBQUcsWUFBWSxDQUFDO1lBQy9CLE1BQU0sVUFBVSxHQUFHLGdDQUFjLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3JELE1BQU0sVUFBVSxHQUFHLGdDQUFjLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRXJELE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzFDLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLDRCQUE0QixFQUFFLEdBQUcsRUFBRTtZQUNwQyxNQUFNLFNBQVMsR0FBRyxnQ0FBYyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUM3QyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzdCLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLDRCQUE0QixFQUFFLEdBQUcsRUFBRTtZQUNwQyxNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3BDLE1BQU0sU0FBUyxHQUFHLGdDQUFjLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3JELE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNoQyxNQUFNLENBQUMsZ0NBQWMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDN0QsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsa0NBQWtDLEVBQUUsR0FBRyxFQUFFO1lBQzFDLE1BQU0sT0FBTyxHQUFHLG9CQUFvQixDQUFDO1lBQ3JDLE1BQU0sU0FBUyxHQUFHLGdDQUFjLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2xELE1BQU0sQ0FBQyxnQ0FBYyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMxRCxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxrQ0FBa0MsRUFBRSxHQUFHLEVBQUU7WUFDMUMsTUFBTSxPQUFPLEdBQUcsNEJBQTRCLENBQUM7WUFDN0MsTUFBTSxTQUFTLEdBQUcsZ0NBQWMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDbEQsTUFBTSxDQUFDLGdDQUFjLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzFELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsU0FBUyxFQUFFLEdBQUcsRUFBRTtRQUN2QixFQUFFLENBQUMsNENBQTRDLEVBQUUsR0FBRyxFQUFFO1lBQ3BELE1BQU0sU0FBUyxHQUFHLHFCQUFxQixDQUFDO1lBQ3hDLE1BQU0sU0FBUyxHQUFHLGdDQUFjLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3BELE1BQU0sU0FBUyxHQUFHLGdDQUFjLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRXBELE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDcEMsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsK0NBQStDLEVBQUUsR0FBRyxFQUFFO1lBQ3ZELE1BQU0sUUFBUSxHQUFHLG9CQUFvQixDQUFDO1lBRXRDLE1BQU0sVUFBVSxHQUFHLGdDQUFjLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3BELE1BQU0sVUFBVSxHQUFHLGdDQUFjLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3RELE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFbEMsTUFBTSxVQUFVLEdBQUcsZ0NBQWMsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDdEQsTUFBTSxVQUFVLEdBQUcsZ0NBQWMsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDdEQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNwQyxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxrREFBa0QsRUFBRSxHQUFHLEVBQUU7WUFDMUQsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLGdDQUFjLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNuRSxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxpREFBaUQsRUFBRSxHQUFHLEVBQUU7WUFDekQsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLGdDQUFjLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDNUQsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsNENBQTRDLEVBQUUsR0FBRyxFQUFFO1lBQ3BELE1BQU0sQ0FBQyxnQ0FBYyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM5QyxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyw2Q0FBNkMsRUFBRSxHQUFHLEVBQUU7WUFDckQsTUFBTSxLQUFLLEdBQUcscUJBQXFCLENBQUMsQ0FBQyxpQkFBaUI7WUFDdEQsTUFBTSxTQUFTLEdBQUcsZ0NBQWMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDaEQsTUFBTSxTQUFTLEdBQUcsZ0NBQWMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDcEQsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNoQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLHFCQUFxQixFQUFFLEdBQUcsRUFBRTtRQUNuQyxFQUFFLENBQUMsNkNBQTZDLEVBQUUsR0FBRyxFQUFFO1lBQ3JELE1BQU0sU0FBUyxHQUFHLFlBQVksQ0FBQztZQUMvQixNQUFNLFVBQVUsR0FBRyxnQ0FBYyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNyRCxNQUFNLFVBQVUsR0FBRyxnQ0FBYyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUVyRCxNQUFNLEdBQUcsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3JDLE1BQU0sR0FBRyxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFckMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsNkNBQTZDLEVBQUUsR0FBRyxFQUFFO1lBQ3JELE1BQU0sU0FBUyxHQUFHLFlBQVksQ0FBQztZQUMvQixNQUFNLFNBQVMsR0FBRyxnQ0FBYyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNwRCxNQUFNLFVBQVUsR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRTNDLHFEQUFxRDtZQUNyRCxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsUUFBUSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ25GLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLDJDQUEyQyxFQUFFLEdBQUcsRUFBRTtZQUNuRCxNQUFNLFNBQVMsR0FBRyxjQUFjLENBQUM7WUFDakMsTUFBTSxTQUFTLEdBQUcsZ0NBQWMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFcEQsNEJBQTRCO1lBQzVCLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsR0FBRyw4QkFBOEIsQ0FBQztZQUUvRCxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsZ0NBQWMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUUxRCxzQkFBc0I7WUFDdEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLE9BQU8sQ0FBQztRQUMxQyxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyx5Q0FBeUMsRUFBRSxHQUFHLEVBQUU7WUFDakQsTUFBTSxTQUFTLEdBQUcsZ0JBQWdCLENBQUM7WUFDbkMsTUFBTSxTQUFTLEdBQUcsZ0NBQWMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFcEQsNkJBQTZCO1lBQzdCLE1BQU0sS0FBSyxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDbkMsTUFBTSxrQkFBa0IsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUM7WUFFNUYsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLGdDQUFjLENBQUMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNyRSxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxpQ0FBaUMsRUFBRSxHQUFHLEVBQUU7WUFDekMsTUFBTSxTQUFTLEdBQUcsZ0JBQWdCLENBQUM7WUFDbkMsTUFBTSxTQUFTLEdBQUcsZ0NBQWMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFcEQscUJBQXFCO1lBQ3JCLE1BQU0sS0FBSyxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDbkMsTUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUM7WUFDbEQsTUFBTSxRQUFRLEdBQUcsVUFBVSxHQUFHLEdBQUcsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUU5RCxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsZ0NBQWMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUMzRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLFlBQVksRUFBRSxHQUFHLEVBQUU7UUFDMUIsRUFBRSxDQUFDLGtDQUFrQyxFQUFFLEdBQUcsRUFBRTtZQUMxQyxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUM7WUFDbEIsTUFBTSxTQUFTLEdBQUcsZ0NBQWMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDaEQsTUFBTSxDQUFDLGdDQUFjLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3hELENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHFDQUFxQyxFQUFFLEdBQUcsRUFBRTtZQUM3QyxNQUFNLFNBQVMsR0FBRyxxQkFBcUIsQ0FBQztZQUN4QyxNQUFNLFNBQVMsR0FBRyxnQ0FBYyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNwRCxNQUFNLENBQUMsZ0NBQWMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDNUQsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsaUNBQWlDLEVBQUUsR0FBRyxFQUFFO1lBQ3pDLE1BQU0sTUFBTSxHQUFHLGtCQUFrQixDQUFDO1lBQ2xDLE1BQU0sU0FBUyxHQUFHLGdDQUFjLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ2pELE1BQU0sQ0FBQyxnQ0FBYyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN6RCxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyw0QkFBNEIsRUFBRSxHQUFHLEVBQUU7WUFDcEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7WUFDbEUsTUFBTSxTQUFTLEdBQUcsZ0NBQWMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDL0MsTUFBTSxDQUFDLGdDQUFjLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3ZELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9sdWlzbmV0bzk4L0RvY3VtZW50b3MvQ29kZS9tb25vcmVwby12dGV4L2FwcHMvYXBpL3Rlc3RzL3VuaXQvY29tbW9uL3V0aWxzL2VuY3J5cHRpb24udXRpbC5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVuY3J5cHRpb25VdGlsIH0gZnJvbSAnLi4vLi4vLi4vLi4vc3JjL2NvbW1vbi91dGlscy9lbmNyeXB0aW9uLnV0aWwnO1xuXG5kZXNjcmliZSgnRW5jcnlwdGlvbiBVdGlsaXRpZXMnLCAoKSA9PiB7XG4gIGNvbnN0IHRlc3RLZXkgPSAndGVzdC1lbmNyeXB0aW9uLWtleS0zMi1ieXRlcyEhJztcbiAgY29uc3Qgb3JpZ2luYWxFbnYgPSBwcm9jZXNzLmVudlsnRU5DUllQVElPTl9LRVknXTtcblxuICBiZWZvcmVBbGwoKCkgPT4ge1xuICAgIHByb2Nlc3MuZW52WydFTkNSWVBUSU9OX0tFWSddID0gdGVzdEtleTtcbiAgfSk7XG5cbiAgYWZ0ZXJBbGwoKCkgPT4ge1xuICAgIHByb2Nlc3MuZW52WydFTkNSWVBUSU9OX0tFWSddID0gb3JpZ2luYWxFbnY7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdlbmNyeXB0JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZW5jcnlwdCBhIHN0cmluZyBzdWNjZXNzZnVsbHknLCAoKSA9PiB7XG4gICAgICBjb25zdCBwbGFpbnRleHQgPSAnbXktZGV2aWNlLXRva2VuLTEyMzQ1JztcbiAgICAgIGNvbnN0IGVuY3J5cHRlZCA9IEVuY3J5cHRpb25VdGlsLmVuY3J5cHQocGxhaW50ZXh0KTtcblxuICAgICAgZXhwZWN0KGVuY3J5cHRlZCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChlbmNyeXB0ZWQpLm5vdC50b0JlKHBsYWludGV4dCk7XG4gICAgICBleHBlY3QoZW5jcnlwdGVkKS50b0NvbnRhaW4oJzonKTsgLy8gU2hvdWxkIGhhdmUgSVYgc2VwYXJhdG9yXG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHByb2R1Y2UgZGlmZmVyZW50IGNpcGhlcnRleHQgZm9yIHNhbWUgaW5wdXQgKGR1ZSB0byByYW5kb20gSVYpJywgKCkgPT4ge1xuICAgICAgY29uc3QgcGxhaW50ZXh0ID0gJ3NhbWUtdG9rZW4nO1xuICAgICAgY29uc3QgZW5jcnlwdGVkMSA9IEVuY3J5cHRpb25VdGlsLmVuY3J5cHQocGxhaW50ZXh0KTtcbiAgICAgIGNvbnN0IGVuY3J5cHRlZDIgPSBFbmNyeXB0aW9uVXRpbC5lbmNyeXB0KHBsYWludGV4dCk7XG5cbiAgICAgIGV4cGVjdChlbmNyeXB0ZWQxKS5ub3QudG9CZShlbmNyeXB0ZWQyKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIGVtcHR5IHN0cmluZycsICgpID0+IHtcbiAgICAgIGNvbnN0IGVuY3J5cHRlZCA9IEVuY3J5cHRpb25VdGlsLmVuY3J5cHQoJycpO1xuICAgICAgZXhwZWN0KGVuY3J5cHRlZCkudG9CZSgnJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBsb25nIHN0cmluZ3MnLCAoKSA9PiB7XG4gICAgICBjb25zdCBsb25nU3RyaW5nID0gJ2EnLnJlcGVhdCgxMDAwKTtcbiAgICAgIGNvbnN0IGVuY3J5cHRlZCA9IEVuY3J5cHRpb25VdGlsLmVuY3J5cHQobG9uZ1N0cmluZyk7XG4gICAgICBleHBlY3QoZW5jcnlwdGVkKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KEVuY3J5cHRpb25VdGlsLmRlY3J5cHQoZW5jcnlwdGVkKSkudG9CZShsb25nU3RyaW5nKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIHVuaWNvZGUgY2hhcmFjdGVycycsICgpID0+IHtcbiAgICAgIGNvbnN0IHVuaWNvZGUgPSAnT2zDoSBtdW5kbyEg5L2g5aW95LiW55WMIPCflJAnO1xuICAgICAgY29uc3QgZW5jcnlwdGVkID0gRW5jcnlwdGlvblV0aWwuZW5jcnlwdCh1bmljb2RlKTtcbiAgICAgIGV4cGVjdChFbmNyeXB0aW9uVXRpbC5kZWNyeXB0KGVuY3J5cHRlZCkpLnRvQmUodW5pY29kZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBzcGVjaWFsIGNoYXJhY3RlcnMnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzcGVjaWFsID0gJyFAIyQlXiYqKClfKy09W117fXw7OiwuPD4/JztcbiAgICAgIGNvbnN0IGVuY3J5cHRlZCA9IEVuY3J5cHRpb25VdGlsLmVuY3J5cHQoc3BlY2lhbCk7XG4gICAgICBleHBlY3QoRW5jcnlwdGlvblV0aWwuZGVjcnlwdChlbmNyeXB0ZWQpKS50b0JlKHNwZWNpYWwpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZGVjcnlwdCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGRlY3J5cHQgZW5jcnlwdGVkIHRleHQgc3VjY2Vzc2Z1bGx5JywgKCkgPT4ge1xuICAgICAgY29uc3QgcGxhaW50ZXh0ID0gJ0ZDTS10b2tlbi1hYmMxMjN4eXonO1xuICAgICAgY29uc3QgZW5jcnlwdGVkID0gRW5jcnlwdGlvblV0aWwuZW5jcnlwdChwbGFpbnRleHQpO1xuICAgICAgY29uc3QgZGVjcnlwdGVkID0gRW5jcnlwdGlvblV0aWwuZGVjcnlwdChlbmNyeXB0ZWQpO1xuXG4gICAgICBleHBlY3QoZGVjcnlwdGVkKS50b0JlKHBsYWludGV4dCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBtdWx0aXBsZSBlbmNyeXB0L2RlY3J5cHQgY3ljbGVzJywgKCkgPT4ge1xuICAgICAgY29uc3Qgb3JpZ2luYWwgPSAnZGV2aWNlLXRva2VuLXZhbHVlJztcblxuICAgICAgY29uc3QgZW5jcnlwdGVkMSA9IEVuY3J5cHRpb25VdGlsLmVuY3J5cHQob3JpZ2luYWwpO1xuICAgICAgY29uc3QgZGVjcnlwdGVkMSA9IEVuY3J5cHRpb25VdGlsLmRlY3J5cHQoZW5jcnlwdGVkMSk7XG4gICAgICBleHBlY3QoZGVjcnlwdGVkMSkudG9CZShvcmlnaW5hbCk7XG5cbiAgICAgIGNvbnN0IGVuY3J5cHRlZDIgPSBFbmNyeXB0aW9uVXRpbC5lbmNyeXB0KGRlY3J5cHRlZDEpO1xuICAgICAgY29uc3QgZGVjcnlwdGVkMiA9IEVuY3J5cHRpb25VdGlsLmRlY3J5cHQoZW5jcnlwdGVkMik7XG4gICAgICBleHBlY3QoZGVjcnlwdGVkMikudG9CZShvcmlnaW5hbCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRocm93IGVycm9yIGZvciBpbnZhbGlkIGNpcGhlcnRleHQgZm9ybWF0JywgKCkgPT4ge1xuICAgICAgZXhwZWN0KCgpID0+IEVuY3J5cHRpb25VdGlsLmRlY3J5cHQoJ2ludmFsaWQtZm9ybWF0JykpLnRvVGhyb3coKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdGhyb3cgZXJyb3IgZm9yIG1hbGZvcm1lZCBlbmNyeXB0ZWQgZGF0YScsICgpID0+IHtcbiAgICAgIGV4cGVjdCgoKSA9PiBFbmNyeXB0aW9uVXRpbC5kZWNyeXB0KCdhYmM6ZGVmJykpLnRvVGhyb3coKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGVtcHR5IHN0cmluZyBmb3IgZW1wdHkgaW5wdXQnLCAoKSA9PiB7XG4gICAgICBleHBlY3QoRW5jcnlwdGlvblV0aWwuZGVjcnlwdCgnJykpLnRvQmUoJycpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgYmFzZTY0IGVuY29kZWQgZGF0YSBjb3JyZWN0bHknLCAoKSA9PiB7XG4gICAgICBjb25zdCB0b2tlbiA9ICdleTEyMy5hYmM0NTYueHl6Nzg5JzsgLy8gSldULWxpa2UgdG9rZW5cbiAgICAgIGNvbnN0IGVuY3J5cHRlZCA9IEVuY3J5cHRpb25VdGlsLmVuY3J5cHQodG9rZW4pO1xuICAgICAgY29uc3QgZGVjcnlwdGVkID0gRW5jcnlwdGlvblV0aWwuZGVjcnlwdChlbmNyeXB0ZWQpO1xuICAgICAgZXhwZWN0KGRlY3J5cHRlZCkudG9CZSh0b2tlbik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdlbmNyeXB0aW9uIHNlY3VyaXR5JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgdXNlIGRpZmZlcmVudCBJViBmb3IgZWFjaCBlbmNyeXB0aW9uJywgKCkgPT4ge1xuICAgICAgY29uc3QgcGxhaW50ZXh0ID0gJ3Rlc3QtdG9rZW4nO1xuICAgICAgY29uc3QgZW5jcnlwdGVkMSA9IEVuY3J5cHRpb25VdGlsLmVuY3J5cHQocGxhaW50ZXh0KTtcbiAgICAgIGNvbnN0IGVuY3J5cHRlZDIgPSBFbmNyeXB0aW9uVXRpbC5lbmNyeXB0KHBsYWludGV4dCk7XG5cbiAgICAgIGNvbnN0IGl2MSA9IGVuY3J5cHRlZDEuc3BsaXQoJzonKVswXTtcbiAgICAgIGNvbnN0IGl2MiA9IGVuY3J5cHRlZDIuc3BsaXQoJzonKVswXTtcblxuICAgICAgZXhwZWN0KGl2MSkubm90LnRvQmUoaXYyKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcHJvZHVjZSBjaXBoZXJ0ZXh0IHRoYXQgbG9va3MgcmFuZG9tJywgKCkgPT4ge1xuICAgICAgY29uc3QgcGxhaW50ZXh0ID0gJ2FhYWFhYWFhYWEnO1xuICAgICAgY29uc3QgZW5jcnlwdGVkID0gRW5jcnlwdGlvblV0aWwuZW5jcnlwdChwbGFpbnRleHQpO1xuICAgICAgY29uc3QgY2lwaGVydGV4dCA9IGVuY3J5cHRlZC5zcGxpdCgnOicpWzFdO1xuXG4gICAgICAvLyBCYXNlNjQgY2lwaGVydGV4dCBzaG91bGQgbm90IGNvbnRhaW4gdGhlIHBsYWludGV4dFxuICAgICAgZXhwZWN0KEJ1ZmZlci5mcm9tKGNpcGhlcnRleHQsICdiYXNlNjQnKS50b1N0cmluZygpKS5ub3QudG9Db250YWluKCdhYWFhYWFhYWFhJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlcXVpcmUgY29ycmVjdCBrZXkgZm9yIGRlY3J5cHRpb24nLCAoKSA9PiB7XG4gICAgICBjb25zdCBwbGFpbnRleHQgPSAnc2VjcmV0LXRva2VuJztcbiAgICAgIGNvbnN0IGVuY3J5cHRlZCA9IEVuY3J5cHRpb25VdGlsLmVuY3J5cHQocGxhaW50ZXh0KTtcblxuICAgICAgLy8gQ2hhbmdlIHRoZSBlbmNyeXB0aW9uIGtleVxuICAgICAgcHJvY2Vzcy5lbnZbJ0VOQ1JZUFRJT05fS0VZJ10gPSAnd3Jvbmcta2V5LTMyLWJ5dGVzLWxlbmd0aCEhISc7XG5cbiAgICAgIGV4cGVjdCgoKSA9PiBFbmNyeXB0aW9uVXRpbC5kZWNyeXB0KGVuY3J5cHRlZCkpLnRvVGhyb3coKTtcblxuICAgICAgLy8gUmVzdG9yZSBjb3JyZWN0IGtleVxuICAgICAgcHJvY2Vzcy5lbnZbJ0VOQ1JZUFRJT05fS0VZJ10gPSB0ZXN0S2V5O1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgdGFtcGVyaW5nIHdpdGggY2lwaGVydGV4dCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHBsYWludGV4dCA9ICdvcmlnaW5hbC10b2tlbic7XG4gICAgICBjb25zdCBlbmNyeXB0ZWQgPSBFbmNyeXB0aW9uVXRpbC5lbmNyeXB0KHBsYWludGV4dCk7XG5cbiAgICAgIC8vIFRhbXBlciB3aXRoIHRoZSBjaXBoZXJ0ZXh0XG4gICAgICBjb25zdCBwYXJ0cyA9IGVuY3J5cHRlZC5zcGxpdCgnOicpO1xuICAgICAgY29uc3QgdGFtcGVyZWRDaXBoZXJ0ZXh0ID0gcGFydHNbMF0gKyAnOicgKyBwYXJ0c1sxXSArICc6JyArIHBhcnRzWzJdLnNsaWNlKDAsIC00KSArICdYWFhYJztcblxuICAgICAgZXhwZWN0KCgpID0+IEVuY3J5cHRpb25VdGlsLmRlY3J5cHQodGFtcGVyZWRDaXBoZXJ0ZXh0KSkudG9UaHJvdygpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgdGFtcGVyaW5nIHdpdGggSVYnLCAoKSA9PiB7XG4gICAgICBjb25zdCBwbGFpbnRleHQgPSAnb3JpZ2luYWwtdG9rZW4nO1xuICAgICAgY29uc3QgZW5jcnlwdGVkID0gRW5jcnlwdGlvblV0aWwuZW5jcnlwdChwbGFpbnRleHQpO1xuXG4gICAgICAvLyBUYW1wZXIgd2l0aCB0aGUgSVZcbiAgICAgIGNvbnN0IHBhcnRzID0gZW5jcnlwdGVkLnNwbGl0KCc6Jyk7XG4gICAgICBjb25zdCB0YW1wZXJlZEl2ID0gcGFydHNbMF0uc2xpY2UoMCwgLTQpICsgJ1lZWVknO1xuICAgICAgY29uc3QgdGFtcGVyZWQgPSB0YW1wZXJlZEl2ICsgJzonICsgcGFydHNbMV0gKyAnOicgKyBwYXJ0c1syXTtcblxuICAgICAgZXhwZWN0KCgpID0+IEVuY3J5cHRpb25VdGlsLmRlY3J5cHQodGFtcGVyZWQpKS50b1Rocm93KCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdlZGdlIGNhc2VzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgaGFuZGxlIHZlcnkgc2hvcnQgc3RyaW5ncycsICgpID0+IHtcbiAgICAgIGNvbnN0IHNob3J0ID0gJ2EnO1xuICAgICAgY29uc3QgZW5jcnlwdGVkID0gRW5jcnlwdGlvblV0aWwuZW5jcnlwdChzaG9ydCk7XG4gICAgICBleHBlY3QoRW5jcnlwdGlvblV0aWwuZGVjcnlwdChlbmNyeXB0ZWQpKS50b0JlKHNob3J0KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIHN0cmluZ3Mgd2l0aCBuZXdsaW5lcycsICgpID0+IHtcbiAgICAgIGNvbnN0IG11bHRpbGluZSA9ICdsaW5lMVxcbmxpbmUyXFxubGluZTMnO1xuICAgICAgY29uc3QgZW5jcnlwdGVkID0gRW5jcnlwdGlvblV0aWwuZW5jcnlwdChtdWx0aWxpbmUpO1xuICAgICAgZXhwZWN0KEVuY3J5cHRpb25VdGlsLmRlY3J5cHQoZW5jcnlwdGVkKSkudG9CZShtdWx0aWxpbmUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgc3RyaW5ncyB3aXRoIHRhYnMnLCAoKSA9PiB7XG4gICAgICBjb25zdCB0YWJiZWQgPSAnY29sMVxcdGNvbDJcXHRjb2wzJztcbiAgICAgIGNvbnN0IGVuY3J5cHRlZCA9IEVuY3J5cHRpb25VdGlsLmVuY3J5cHQodGFiYmVkKTtcbiAgICAgIGV4cGVjdChFbmNyeXB0aW9uVXRpbC5kZWNyeXB0KGVuY3J5cHRlZCkpLnRvQmUodGFiYmVkKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIEpTT04gc3RyaW5ncycsICgpID0+IHtcbiAgICAgIGNvbnN0IGpzb24gPSBKU09OLnN0cmluZ2lmeSh7IHRva2VuOiAnYWJjMTIzJywgcGxhdGZvcm06ICdpb3MnIH0pO1xuICAgICAgY29uc3QgZW5jcnlwdGVkID0gRW5jcnlwdGlvblV0aWwuZW5jcnlwdChqc29uKTtcbiAgICAgIGV4cGVjdChFbmNyeXB0aW9uVXRpbC5kZWNyeXB0KGVuY3J5cHRlZCkpLnRvQmUoanNvbik7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=