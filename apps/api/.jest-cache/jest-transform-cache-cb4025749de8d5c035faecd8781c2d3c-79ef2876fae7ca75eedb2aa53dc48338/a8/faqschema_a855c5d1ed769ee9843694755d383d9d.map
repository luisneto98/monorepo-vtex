{"file":"/home/luisneto98/Documentos/Code/monorepo-vtex/apps/api/src/modules/faq/schemas/faq.schema.ts","mappings":"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","names":[],"sources":["/home/luisneto98/Documentos/Code/monorepo-vtex/apps/api/src/modules/faq/schemas/faq.schema.ts"],"sourcesContent":["import { Prop, Schema, SchemaFactory } from '@nestjs/mongoose';\nimport { Document, Schema as MongooseSchema } from 'mongoose';\nimport { Faq as IFaq } from '@shared/types/faq.types';\nimport * as DOMPurify from 'isomorphic-dompurify';\nimport { FAQ_CONSTANTS } from '../faq.constants';\n\nexport type FaqDocument = Faq & Document;\n\n@Schema({ _id: false })\nclass Question {\n  @Prop({\n    required: true,\n    maxlength: FAQ_CONSTANTS.QUESTION_MAX_LENGTH,\n    trim: true,\n  })\n  'pt-BR': string;\n\n  @Prop({\n    required: true,\n    maxlength: FAQ_CONSTANTS.QUESTION_MAX_LENGTH,\n    trim: true,\n  })\n  'en': string;\n}\n\n@Schema({ _id: false })\nclass Answer {\n  @Prop({\n    required: true,\n    maxlength: FAQ_CONSTANTS.ANSWER_MAX_LENGTH,\n    trim: true,\n  })\n  'pt-BR': string;\n\n  @Prop({\n    required: true,\n    maxlength: FAQ_CONSTANTS.ANSWER_MAX_LENGTH,\n    trim: true,\n  })\n  'en': string;\n}\n\n@Schema({ timestamps: true, collection: 'Faq' })\nexport class Faq implements Omit<IFaq, '_id'> {\n  @Prop({\n    type: Question,\n    required: true,\n  })\n  question: {\n    'pt-BR': string;\n    en: string;\n  };\n\n  @Prop({\n    type: Answer,\n    required: true,\n  })\n  answer: {\n    'pt-BR': string;\n    en: string;\n  };\n\n  @Prop({\n    type: MongooseSchema.Types.ObjectId,\n    ref: 'FaqCategory',\n    required: true,\n    index: true,\n  })\n  category: string;\n\n  @Prop({\n    required: true,\n    min: FAQ_CONSTANTS.ORDER_MIN_VALUE,\n  })\n  order: number;\n\n  @Prop({\n    default: 0,\n    min: FAQ_CONSTANTS.VIEW_COUNT_MIN_VALUE,\n  })\n  viewCount: number;\n\n  @Prop({\n    default: true,\n    index: true,\n  })\n  isVisible: boolean;\n\n  @Prop({\n    type: Date,\n    default: null,\n  })\n  deletedAt?: Date;\n\n  @Prop({\n    type: MongooseSchema.Types.ObjectId,\n    ref: 'User',\n  })\n  deletedBy?: MongooseSchema.Types.ObjectId;\n\n  @Prop({\n    type: String,\n  })\n  deleteReason?: string;\n}\n\nexport const FaqSchema = SchemaFactory.createForClass(Faq);\n\n// Indexes\nFaqSchema.index({ category: 1, order: 1 });\nFaqSchema.index({ viewCount: -1 });\nFaqSchema.index({ isVisible: 1 });\nFaqSchema.index({ deletedAt: 1 });\n// Compound index for common query pattern (category + visibility + soft delete)\nFaqSchema.index({ category: 1, isVisible: 1, deletedAt: 1 });\nFaqSchema.index({\n  'question.pt-BR': 'text',\n  'question.en': 'text',\n  'answer.pt-BR': 'text',\n  'answer.en': 'text',\n});\n\n// Pre-save middleware for data normalization and HTML sanitization\nFaqSchema.pre('save', function (next) {\n  if (this.question) {\n    if (this.question['pt-BR']) {\n      this.question['pt-BR'] = this.question['pt-BR'].trim();\n    }\n    if (this.question['en']) {\n      this.question['en'] = this.question['en'].trim();\n    }\n  }\n\n  if (this.answer) {\n    if (this.answer['pt-BR']) {\n      this.answer['pt-BR'] = sanitizeHtml(this.answer['pt-BR'].trim());\n    }\n    if (this.answer['en']) {\n      this.answer['en'] = sanitizeHtml(this.answer['en'].trim());\n    }\n  }\n\n  next();\n});\n\n// Helper function for HTML sanitization\nfunction sanitizeHtml(html: string): string {\n  const config = {\n    ALLOWED_TAGS: [\n      'b',\n      'i',\n      'em',\n      'strong',\n      'a',\n      'p',\n      'br',\n      'ul',\n      'ol',\n      'li',\n      'h3',\n      'h4',\n      'h5',\n      'h6',\n    ],\n    ALLOWED_ATTR: ['href', 'target', 'rel'],\n    ALLOW_DATA_ATTR: false,\n  };\n\n  return DOMPurify.sanitize(html, config);\n}\n\n// Virtual fields\nFaqSchema.virtual('popularity').get(function () {\n  return this.viewCount || 0;\n});\n\n// Schema methods\nFaqSchema.methods['getLocalizedQuestion'] = function (language: 'pt-BR' | 'en'): string {\n  return this['question'][language] || this['question']['pt-BR'];\n};\n\nFaqSchema.methods['getLocalizedAnswer'] = function (language: 'pt-BR' | 'en'): string {\n  return this['answer'][language] || this['answer']['pt-BR'];\n};\n\nFaqSchema.methods['incrementViewCount'] = function (): void {\n  this['viewCount'] = (this['viewCount'] || 0) + 1;\n};\n"],"version":3}