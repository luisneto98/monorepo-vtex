{"version":3,"names":["cov_1xcbh134r6","actualCoverage","common_1","s","require","config_1","client_s3_1","s3_request_presigner_1","S3StorageService","S3StorageService_1","configService","s3Client","bucketName","region","logger","Logger","name","constructor","f","get","S3Client","credentials","accessKeyId","secretAccessKey","uploadFile","key","file","metadata","command","PutObjectCommand","Bucket","Key","Body","buffer","ContentType","mimetype","Metadata","send","url","log","error","message","stack","InternalServerErrorException","getFile","GetObjectCommand","response","deleteFile","DeleteObjectCommand","getFileMetadata","HeadObjectCommand","size","b","ContentLength","contentType","getSignedDownloadUrl","expiresIn","getSignedUrl","generateFileKey","filename","prefix","uniqueSuffix","Date","now","Math","round","random","extension","split","pop","exports","__decorate","Injectable","ConfigService"],"sources":["/home/luisneto98/Documentos/Code/monorepo-vtex/apps/api/src/modules/legal-pages/services/s3-storage.service.ts"],"sourcesContent":["import { Injectable, InternalServerErrorException, Logger } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport {\n  S3Client,\n  PutObjectCommand,\n  GetObjectCommand,\n  DeleteObjectCommand,\n  HeadObjectCommand,\n} from '@aws-sdk/client-s3';\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\nimport { Readable } from 'stream';\n\n@Injectable()\nexport class S3StorageService {\n  private readonly s3Client: S3Client;\n  private readonly bucketName: string;\n  private readonly region: string;\n  private readonly logger = new Logger(S3StorageService.name);\n\n  constructor(private configService: ConfigService) {\n    this.region = this.configService.get<string>('AWS_REGION', 'us-east-1');\n    this.bucketName = this.configService.get<string>('AWS_S3_BUCKET', 'vtexday26-legal-docs');\n\n    this.s3Client = new S3Client({\n      region: this.region,\n      credentials: {\n        accessKeyId: this.configService.get<string>('AWS_ACCESS_KEY_ID', ''),\n        secretAccessKey: this.configService.get<string>('AWS_SECRET_ACCESS_KEY', ''),\n      },\n    });\n  }\n\n  async uploadFile(\n    key: string,\n    file: Express.Multer.File,\n    metadata?: Record<string, string>,\n  ): Promise<{ key: string; url: string }> {\n    try {\n      const command = new PutObjectCommand({\n        Bucket: this.bucketName,\n        Key: key,\n        Body: file.buffer,\n        ContentType: file.mimetype,\n        Metadata: metadata,\n      });\n\n      await this.s3Client.send(command);\n\n      const url = `https://${this.bucketName}.s3.${this.region}.amazonaws.com/${key}`;\n\n      this.logger.log(`File uploaded successfully to S3: ${key}`);\n      return { key, url };\n    } catch (error: any) {\n      this.logger.error(`Failed to upload file to S3: ${error.message}`, error.stack);\n      throw new InternalServerErrorException('Failed to upload file to storage');\n    }\n  }\n\n  async getFile(key: string): Promise<Readable> {\n    try {\n      const command = new GetObjectCommand({\n        Bucket: this.bucketName,\n        Key: key,\n      });\n\n      const response = await this.s3Client.send(command);\n      return response.Body as Readable;\n    } catch (error: any) {\n      this.logger.error(`Failed to get file from S3: ${error.message}`, error.stack);\n      throw new InternalServerErrorException('Failed to retrieve file from storage');\n    }\n  }\n\n  async deleteFile(key: string): Promise<void> {\n    try {\n      const command = new DeleteObjectCommand({\n        Bucket: this.bucketName,\n        Key: key,\n      });\n\n      await this.s3Client.send(command);\n      this.logger.log(`File deleted successfully from S3: ${key}`);\n    } catch (error: any) {\n      this.logger.error(`Failed to delete file from S3: ${error.message}`, error.stack);\n      // Don't throw error on delete failure, just log it\n    }\n  }\n\n  async getFileMetadata(key: string): Promise<{ size: number; contentType: string }> {\n    try {\n      const command = new HeadObjectCommand({\n        Bucket: this.bucketName,\n        Key: key,\n      });\n\n      const response = await this.s3Client.send(command);\n      return {\n        size: response.ContentLength || 0,\n        contentType: response.ContentType || 'application/pdf',\n      };\n    } catch (error: any) {\n      this.logger.error(`Failed to get file metadata from S3: ${error.message}`, error.stack);\n      throw new InternalServerErrorException('Failed to retrieve file metadata');\n    }\n  }\n\n  async getSignedDownloadUrl(key: string, expiresIn = 3600): Promise<string> {\n    try {\n      const command = new GetObjectCommand({\n        Bucket: this.bucketName,\n        Key: key,\n      });\n\n      return await getSignedUrl(this.s3Client, command, { expiresIn });\n    } catch (error: any) {\n      this.logger.error(`Failed to generate signed URL: ${error.message}`, error.stack);\n      throw new InternalServerErrorException('Failed to generate download URL');\n    }\n  }\n\n  generateFileKey(filename: string, prefix = 'legal-pages'): string {\n    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1e9);\n    const extension = filename.split('.').pop();\n    return `${prefix}/${uniqueSuffix}.${extension}`;\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}