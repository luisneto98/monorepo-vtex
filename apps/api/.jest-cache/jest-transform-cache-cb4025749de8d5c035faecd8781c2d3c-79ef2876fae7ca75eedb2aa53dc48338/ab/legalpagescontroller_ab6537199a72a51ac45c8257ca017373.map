{"file":"/home/luisneto98/Documentos/Code/monorepo-vtex/apps/api/src/modules/legal-pages/legal-pages.controller.ts","mappings":"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","names":[],"sources":["/home/luisneto98/Documentos/Code/monorepo-vtex/apps/api/src/modules/legal-pages/legal-pages.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Post,\n  Put,\n  Delete,\n  Body,\n  Param,\n  UseGuards,\n  UseInterceptors,\n  UploadedFile,\n  Query,\n  Res,\n  HttpStatus,\n  ParseFilePipeBuilder,\n  Request,\n} from '@nestjs/common';\nimport { FileInterceptor } from '@nestjs/platform-express';\nimport { Response } from 'express';\nimport { LegalPagesService } from './legal-pages.service';\nimport { CreateLegalPageDto } from './dto/create-legal-page.dto';\nimport { UpdateLegalPageDto } from './dto/update-legal-page.dto';\nimport { SupportedLanguage } from './dto/upload-file.dto';\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\nimport { Roles } from '../auth/decorators/roles.decorator';\nimport { RolesGuard } from '../auth/guards/roles.guard';\nimport { Throttle } from '@nestjs/throttler';\nimport { UserRole } from '@vtexday26/shared';\n\n@Controller('legal-pages')\nexport class LegalPagesController {\n  constructor(private readonly legalPagesService: LegalPagesService) {}\n\n  @Post()\n  @UseGuards(JwtAuthGuard, RolesGuard)\n  @Roles(UserRole.SUPER_ADMIN, UserRole.PRODUCER)\n  @Throttle({ default: { limit: 10, ttl: 60 } })\n  async create(@Body() createLegalPageDto: CreateLegalPageDto) {\n    return this.legalPagesService.create(createLegalPageDto);\n  }\n\n  @Get()\n  @UseGuards(JwtAuthGuard, RolesGuard)\n  @Roles(UserRole.SUPER_ADMIN, UserRole.PRODUCER)\n  async findAll(@Query('isActive') isActive?: string) {\n    const active = isActive === 'true' ? true : isActive === 'false' ? false : undefined;\n    return this.legalPagesService.findAll(active);\n  }\n\n  @Get(':id')\n  @UseGuards(JwtAuthGuard, RolesGuard)\n  @Roles(UserRole.SUPER_ADMIN, UserRole.PRODUCER)\n  async findOne(@Param('id') id: string) {\n    return this.legalPagesService.findOne(id);\n  }\n\n  @Put(':id')\n  @UseGuards(JwtAuthGuard, RolesGuard)\n  @Roles(UserRole.SUPER_ADMIN, UserRole.PRODUCER)\n  async update(\n    @Param('id') id: string,\n    @Body() updateLegalPageDto: UpdateLegalPageDto,\n    @Request() req,\n  ) {\n    return this.legalPagesService.update(id, updateLegalPageDto, req.user.id);\n  }\n\n  @Post(':id/upload')\n  @UseGuards(JwtAuthGuard, RolesGuard)\n  @Roles(UserRole.SUPER_ADMIN, UserRole.PRODUCER)\n  @UseInterceptors(FileInterceptor('file'))\n  @Throttle({ default: { limit: 5, ttl: 60 } })\n  async uploadFile(\n    @Param('id') id: string,\n    @UploadedFile(\n      new ParseFilePipeBuilder()\n        .addFileTypeValidator({\n          fileType: 'application/pdf',\n        })\n        .addMaxSizeValidator({\n          maxSize: 10 * 1024 * 1024, // 10MB\n        })\n        .build({\n          errorHttpStatusCode: HttpStatus.UNPROCESSABLE_ENTITY,\n        }),\n    )\n    file: Express.Multer.File,\n    @Body('language') language: SupportedLanguage,\n    @Request() req,\n  ) {\n    return this.legalPagesService.uploadFile(id, file, language, req.user.id);\n  }\n\n  @Delete(':id/file/:language')\n  @UseGuards(JwtAuthGuard, RolesGuard)\n  @Roles(UserRole.SUPER_ADMIN, UserRole.PRODUCER)\n  async deleteFile(\n    @Param('id') id: string,\n    @Param('language') language: SupportedLanguage,\n    @Request() req,\n  ) {\n    return this.legalPagesService.deleteFile(id, language, req.user.id);\n  }\n\n  @Delete(':id')\n  @UseGuards(JwtAuthGuard, RolesGuard)\n  @Roles(UserRole.SUPER_ADMIN, UserRole.PRODUCER)\n  async remove(@Param('id') id: string) {\n    await this.legalPagesService.remove(id);\n    return { message: 'Legal page deleted successfully' };\n  }\n\n  @Get('public/list')\n  @Throttle({ default: { limit: 100, ttl: 60 } })\n  async getPublicPages() {\n    return this.legalPagesService.getPublicPages();\n  }\n\n  @Get('public/:slug/:language/download')\n  @Throttle({ default: { limit: 50, ttl: 60 } })\n  async downloadFile(\n    @Param('slug') slug: string,\n    @Param('language') language: SupportedLanguage,\n    @Res() res: Response,\n  ) {\n    try {\n      const { stream, metadata } = await this.legalPagesService.getFileStream(slug, language);\n\n      res.set({\n        'Content-Type': 'application/pdf',\n        'Content-Disposition': `attachment; filename=\"${metadata.originalName}\"`,\n        'Content-Length': metadata.size.toString(),\n      });\n\n      stream.pipe(res);\n    } catch (error: any) {\n      if (error.status) {\n        res.status(error.status).json({ message: error.message });\n      } else {\n        res.status(HttpStatus.INTERNAL_SERVER_ERROR).json({ message: 'Error downloading file' });\n      }\n    }\n  }\n\n  @Get('public/:slug/:language/url')\n  @Throttle({ default: { limit: 100, ttl: 60 } })\n  async getDownloadUrl(\n    @Param('slug') slug: string,\n    @Param('language') language: SupportedLanguage,\n  ) {\n    return this.legalPagesService.getSignedDownloadUrl(slug, language);\n  }\n}\n"],"version":3}