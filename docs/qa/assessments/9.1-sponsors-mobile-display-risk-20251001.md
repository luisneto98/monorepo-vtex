# Risk Profile: Story 9.1 - Public Sponsors Display in Mobile App

**Date:** 2025-10-01
**Reviewer:** Quinn (Test Architect)
**Story:** 9.1 - Public Sponsors Display in Mobile App

---

## Executive Summary

- **Total Risks Identified:** 8
- **Critical Risks (Score 9):** 1
- **High Risks (Score 6):** 2
- **Medium Risks (Score 4):** 3
- **Low Risks (Score 2-3):** 2
- **Overall Risk Score:** 59/100 (Moderate Risk)

**Status:** ‚õî **FAIL** - Critical security issue must be fixed before production deployment

---

## Critical Risks Requiring Immediate Attention

### SEC-001: Internal `isVisible` Field Exposed to Public API ‚ö†Ô∏è CONFIRMED

**Score: 9 (Critical)**
**Probability:** High (3) - Field is confirmed present in API responses via integration tests
**Impact:** High (3) - Exposes internal business logic, enables enumeration of hidden sponsors

**Affected Components:**
- `apps/api/src/modules/sponsors/sponsors.service.ts:370` - findPublicSponsors()
- `apps/api/src/modules/sponsors/sponsors.service.ts:397` - findPublicSponsorsByTier()
- `apps/api/tests/integration/sponsors-public.integration.spec.ts:131,227` - Tests VERIFY field is present

**Evidence:**
```typescript
// Current code (INCORRECT):
.select('-maxPosts -postsUsed -adminEmail -deletedAt -deletedBy -deleteReason -__v')

// Integration test confirms field is returned:
expect(sponsor.isVisible).toBe(true); // Line 131, 227
```

**Why This Is Critical:**
1. `isVisible` is an internal field controlling sponsor visibility
2. Public API consumers should NOT know this implementation detail
3. Attackers can enumerate sponsors by testing visibility states
4. Violates principle of least privilege - public users don't need this info

**Required Fix:**
```typescript
// Add -isVisible to exclusion list:
.select('-maxPosts -postsUsed -adminEmail -isVisible -deletedAt -deletedBy -deleteReason -__v')
```

**Mitigation Steps:**
1. **IMMEDIATE**: Add `-isVisible` to `.select()` exclusion in `sponsors.service.ts:370,397`
2. **UPDATE TESTS**: Remove `isVisible` assertions from integration tests (lines 131, 227)
3. **ADD TEST**: Verify `isVisible` is NOT in public API response
4. **VERIFY**: Confirm mobile app works without this field (it should, as it only checks visibility server-side)

**Testing Requirements:**
- [ ] Update integration test to verify `isVisible` is undefined
- [ ] Security audit to confirm no other internal fields exposed
- [ ] Mobile app regression test to ensure no breaking changes

**Residual Risk:** Low after mitigation - Field will be properly excluded

---

## High Risks

### PERF-001: Missing Composite Index for Public Query Pattern

**Score: 6 (High)**
**Probability:** Medium (2) - Query uses `{isVisible: true, deletedAt: null}` without composite index
**Impact:** High (3) - Table scan on large datasets causes slow response (>1s for 1000+ sponsors)

**Affected Components:**
- `apps/api/src/modules/sponsors/sponsors.service.ts:360,390` - Public queries
- `apps/api/src/modules/sponsors/schemas/sponsor.schema.ts:165-168` - Index definitions

**Current State:**
- Individual indexes exist: `isVisible: 1` (line 167) and `deletedAt: 1` (line 168)
- No composite index for common query pattern: `{isVisible: true, deletedAt: null}`

**Performance Impact:**
- MongoDB must use only one index, then filter results in memory
- Estimated: ~500ms for 500 sponsors, ~2s for 2000 sponsors
- Public endpoints will suffer from poor UX

**Required Fix:**
```typescript
// Add to sponsor.schema.ts after line 168:
SponsorSchema.index({ isVisible: 1, deletedAt: 1, tier: 1, orderInTier: 1 });
```

**Mitigation Steps:**
1. Add composite index covering full query pattern
2. Run `explain()` to verify index usage
3. Load test with 1000+ sponsors to measure improvement
4. Set performance budget: p95 < 100ms

**Testing Requirements:**
- [ ] Load test: 1000 sponsors, verify <100ms response time
- [ ] Query execution plan: verify composite index is used
- [ ] Monitor index size and build time

**Residual Risk:** Low - Composite index will optimize query to O(log n)

---

### DATA-001: Mobile Service Unit Tests Created ‚úÖ RESOLVED

**Score: 6 ‚Üí 0 (RESOLVED)**
**Probability:** N/A - File now exists
**Impact:** N/A - Comprehensive tests created

**Resolution:**
- File created at: `apps/mobile/tests/unit/services/SponsorsService.test.ts`
- 293 lines of comprehensive test coverage
- Tests cover:
  - ‚úÖ Cache hit/miss scenarios
  - ‚úÖ Error transformation (404, 500, network errors)
  - ‚úÖ Background refresh behavior
  - ‚úÖ Locale handling (getLocalizedDescription, getLocalizedTierName)
  - ‚úÖ Stale cache fallback on errors
  - ‚úÖ Cache invalidation

**Status:** ‚úÖ **RESOLVED** - No further action needed

---

## Medium Risks

### TECH-001: Inconsistent Public Endpoint Field Exposure

**Score: 4 (Medium)**
**Probability:** Medium (2) - Different endpoints use different patterns
**Impact:** Medium (2) - Maintenance burden, risk of future data leaks

**Affected Components:**
- `GET /sponsors/public` - Uses `.select()` exclusion (line 370)
- `GET /sponsors/public/grouped-by-tier` - Uses same pattern (line 397)
- `GET /sponsors/:id` - Returns ALL fields including sensitive ones (line 410-437)

**Risk Details:**
- `/sponsors/:id` is marked `@Public()` but doesn't filter fields
- No centralized constant for public field exclusions
- Easy to forget exclusions when adding new sensitive fields

**Mitigation:**
```typescript
// Create constant in sponsors.service.ts:
const PUBLIC_SPONSOR_SELECT = '-maxPosts -postsUsed -adminEmail -isVisible -deletedAt -deletedBy -deleteReason -__v';

// Use consistently:
.select(PUBLIC_SPONSOR_SELECT)
```

**Additional Actions:**
- Audit `/sponsors/:id` endpoint for field exposure
- Document public vs internal field policy
- Consider DTO-based transformation instead of `.select()`

**Residual Risk:** Medium - Requires ongoing discipline

---

### OPS-001: No Rate Limiting on Public Endpoints

**Score: 4 (Medium)**
**Probability:** Medium (2) - Public endpoints have no throttling
**Impact:** Medium (2) - Vulnerable to DoS, resource exhaustion

**Affected Components:**
- `GET /sponsors/public` (line 267-311)
- `GET /sponsors/public/grouped-by-tier` (line 313-369)
- Note: Logo upload HAS throttling (@Throttle decorator, line 499)

**Current State:**
- Upload endpoint: Rate limited to 5 req/min (line 499)
- Public read endpoints: NO rate limiting configured

**Recommended Limits:**
```typescript
@Throttle({ default: { limit: 100, ttl: 60000 } }) // 100 req/min
@Get('public')
```

**Mitigation:**
- Add @Throttle decorator to public endpoints
- Configure different limits: 100/min for list, 200/min for grouped
- Set up monitoring alerts for rate limit hits
- Consider IP-based throttling for abuse prevention

**Residual Risk:** Medium - Requires monitoring setup

---

### BUS-001: Locale Detection Not Implemented in Mobile UI

**Score: 4 (Medium)**
**Probability:** High (3) - TODO comment confirms it's incomplete
**Impact:** Low (1) - Wrong language shown, minor UX issue

**Affected Components:**
- `apps/mobile/src/screens/Sponsors/SponsorsListScreen.tsx:64-66`

**Current Code:**
```typescript
const getLocalizedTierName = (tierDisplayName) => {
  // TODO: Get device locale and use it
  return tierDisplayName['pt-BR']; // Always returns Portuguese
};
```

**Impact:**
- English-speaking users see Portuguese tier names
- Violates i18n best practices
- Service has correct logic, just not used in UI

**Fix:**
```typescript
import { getLocales } from 'react-native-localize';

const getLocalizedTierName = (tierDisplayName) => {
  const locale = getLocales()[0]?.languageCode || 'pt';
  return SponsorsService.getLocalizedTierName(tierDisplayName, locale);
};
```

**Testing:**
- Test on iOS with English locale settings
- Test on Android with Portuguese locale
- Verify fallback to pt-BR works

**Residual Risk:** Low - Simple implementation fix

---

## Low Risks

### TECH-002: Deep Linking Not Integration Tested

**Score: 3 (Low)**
**Probability:** Low (1) - Standard React Navigation pattern used
**Impact:** High (3) - Deep links could fail silently in production

**Affected Components:**
- `apps/mobile/src/navigation/AppNavigator.tsx` - Routes registered
- No E2E test for deep linking

**Current State:**
- Navigation properly configured
- Manual testing completed (per story DoD)
- No automated test coverage

**Recommended Tests:**
- Deep link: `vtexday://sponsors/{id}`
- Universal link: `https://app.vtexday.com/sponsors/{id}`
- Test on iOS and Android

**Residual Risk:** Low - Deep linking is standard RN pattern

---

### DATA-002: Long Cache TTL May Show Stale Data

**Score: 2 (Low)**
**Probability:** Low (1) - Sponsor data changes infrequently
**Impact:** Medium (2) - Users see outdated sponsor info up to 24h

**Affected Components:**
- `apps/mobile/src/services/SponsorsService.ts:6` - 24h cache TTL

**Current Behavior:**
- 24-hour cache with stale-while-revalidate
- Background refresh on app open
- Pull-to-refresh for manual update

**Consideration:**
- Sponsors rarely change during event
- 24h cache reduces server load
- Users can manually refresh

**Potential Improvements:**
- Shorter TTL (6-12h) during event week
- Push notification for sponsor updates
- Cache versioning tied to app version

**Residual Risk:** Low - Acceptable for this use case

---

## Risk Distribution

### By Category
- **Security (SEC):** 1 risk (1 critical) ‚õî
- **Performance (PERF):** 1 risk (1 high) ‚ö†Ô∏è
- **Data (DATA):** 1 risk (1 resolved) ‚úÖ
- **Business (BUS):** 1 risk (1 medium)
- **Operational (OPS):** 1 risk (1 medium)
- **Technical (TECH):** 2 risks (1 medium, 1 low)

### By Component
- **Backend API:** 4 risks (1 critical, 1 high, 2 medium)
- **Mobile App:** 2 risks (1 medium, 1 low)
- **Infrastructure:** 1 risk (1 low)

### By Severity
- **Must Fix (9):** 1 risk - SEC-001
- **Should Fix (6):** 1 risk - PERF-001
- **Can Fix Later (4):** 3 risks - TECH-001, OPS-001, BUS-001
- **Monitor (2-3):** 2 risks - TECH-002, DATA-002
- **Resolved (0):** 1 risk - DATA-001

---

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Verification (BEFORE Production) ‚õî

**SEC-001 - Fix `isVisible` Exposure:**

**Required Changes:**
```typescript
// sponsors.service.ts:370 and 397
.select('-maxPosts -postsUsed -adminEmail -isVisible -deletedAt -deletedBy -deleteReason -__v')
```

**Test Updates Required:**
1. Update `sponsors-public.integration.spec.ts:131,227`:
   ```typescript
   // REMOVE these assertions:
   expect(sponsor.isVisible).toBe(true);

   // ADD this assertion:
   expect(sponsor.isVisible).toBeUndefined();
   ```

2. Add dedicated security test:
   ```typescript
   it('should NOT expose isVisible field', async () => {
     const response = await request(app.getHttpServer())
       .get('/sponsors/public')
       .expect(200);

     response.body.data.forEach((sponsor: any) => {
       expect(sponsor.isVisible).toBeUndefined();
     });
   });
   ```

3. Run security scan to verify no other internal fields leaked

**Acceptance:** All tests pass, `isVisible` confirmed excluded

---

### Priority 2: High Risk Mitigation

**PERF-001 - Add Composite Index:**

**Required Changes:**
```typescript
// sponsor.schema.ts - Add after line 168:
SponsorSchema.index({ isVisible: 1, deletedAt: 1, tier: 1, orderInTier: 1 });
```

**Performance Tests:**
1. Load test: 1000 sponsors ‚Üí verify <100ms p95 response
2. Run `explain()` to verify index usage
3. Benchmark before/after index creation

**Acceptance:** Query uses composite index, p95 < 100ms

---

### Priority 3: Medium Risk Monitoring

**TECH-001 - Centralize Field Exclusions:**
- Refactor to use constant for `.select()` patterns
- Audit `/sponsors/:id` endpoint

**OPS-001 - Add Rate Limiting:**
- Add `@Throttle` decorator to public endpoints
- Monitor rate limit violations

**BUS-001 - Implement Locale Detection:**
- Use `react-native-localize` for device locale
- Test with different OS locale settings

---

## Detailed Risk Register

| Risk ID  | Category | Description                              | Probability | Impact | Score | Priority | Status       |
| -------- | -------- | ---------------------------------------- | ----------- | ------ | ----- | -------- | ------------ |
| SEC-001  | Security | isVisible field exposed to public API    | High (3)    | High (3)   | 9     | Critical | ‚õî MUST FIX  |
| PERF-001 | Performance | Missing composite index for public query | Medium (2)  | High (3)   | 6     | High     | ‚ö†Ô∏è SHOULD FIX |
| DATA-001 | Data     | Mobile service tests missing             | N/A         | N/A        | 0     | N/A      | ‚úÖ RESOLVED   |
| TECH-001 | Technical | Inconsistent field exposure patterns     | Medium (2)  | Medium (2) | 4     | Medium   | Monitor      |
| OPS-001  | Operational | No rate limiting on public endpoints     | Medium (2)  | Medium (2) | 4     | Medium   | Monitor      |
| BUS-001  | Business | Locale detection not implemented         | High (3)    | Low (1)    | 4     | Medium   | Monitor      |
| TECH-002 | Technical | Deep linking not integration tested     | Low (1)     | High (3)   | 3     | Low      | Accept       |
| DATA-002 | Data     | Long cache TTL (24h)                     | Low (1)     | Medium (2) | 2     | Low      | Accept       |

---

## Risk Acceptance Criteria

### ‚õî Must Fix Before Production
1. **SEC-001:** Add `-isVisible` to `.select()` exclusion and verify via tests
2. **PERF-001:** Add composite index and verify query performance

### ‚ö†Ô∏è Can Deploy with Mitigation Plan
1. **TECH-001:** Create centralized field exclusion constant (next sprint)
2. **OPS-001:** Add rate limiting and monitoring (can add post-launch)
3. **BUS-001:** Implement locale detection (UX improvement, not blocker)

### ‚úÖ Accepted Risks
1. **DATA-001:** ‚úÖ Resolved - tests created
2. **TECH-002:** Deep linking tested manually, E2E tests later
3. **DATA-002:** 24h cache acceptable for sponsor data

---

## Monitoring Requirements

### Performance Metrics (PERF-001)
- **Query Execution Time:** p50 < 50ms, p95 < 100ms, p99 < 200ms
- **Database Metrics:** Index usage %, slow query log
- **Cache Performance:** Hit ratio > 80%

### Security Monitoring (SEC-001)
- **Field Exposure Audit:** Daily automated scan of public API responses
- **Enumeration Detection:** Alert on >100 requests/min from single IP
- **Access Patterns:** Monitor unusual query patterns

### Error Tracking (OPS-001)
- **Error Rate:** Alert if >5% of requests fail
- **Mobile Service Errors:** Track by error code (NETWORK_ERROR, SERVER_ERROR)
- **Cache Failures:** Monitor AsyncStorage exceptions

### Business Metrics (BUS-001)
- **Sponsor Page Views:** Track by tier, device locale
- **Deep Link Success Rate:** % of deep links that navigate successfully
- **User Engagement:** Time spent on sponsors screen

---

## Risk Review Triggers

**Re-evaluate this risk profile when:**

1. **Schema Changes:**
   - New fields added to Sponsor schema
   - Sensitive data classification changes

2. **Performance Issues:**
   - Response time exceeds 500ms p95
   - Database slow query alerts

3. **Security Events:**
   - Data exposure incident
   - Security vulnerability in NestJS/React Native

4. **Architecture Changes:**
   - New public endpoints added
   - Caching strategy modified
   - Authentication model changes

5. **Scale Events:**
   - Sponsor count exceeds 500
   - Traffic exceeds 1000 req/min
   - Database query patterns change

---

## Recommendations Summary

### Immediate Actions (Before Production) ‚õî
1. **Fix SEC-001:** Add `-isVisible` to select exclusion (2 locations)
2. **Fix PERF-001:** Add composite index `{isVisible:1, deletedAt:1, tier:1, orderInTier:1}`
3. **Update Tests:** Remove `isVisible` assertions, add exclusion verification
4. **Run Security Scan:** Verify no other internal fields exposed

### Short-term Actions (Next Sprint) ‚ö†Ô∏è
1. **TECH-001:** Create `PUBLIC_SPONSOR_SELECT` constant
2. **OPS-001:** Add rate limiting to public endpoints (100/min)
3. **BUS-001:** Implement locale detection in mobile UI

### Long-term Monitoring üìä
1. Set up APM dashboards for public endpoints
2. Configure alerts for performance/security anomalies
3. Establish regular security audits for public APIs

---

## Gate Decision

**Decision:** ‚õî **FAIL**

**Rationale:**
- **1 Critical Risk (SEC-001)** exposes internal field to public API
- **1 High Risk (PERF-001)** impacts performance at scale
- Both must be fixed before production deployment

**Required for PASS:**
1. ‚úÖ Exclude `isVisible` from public API responses
2. ‚úÖ Add composite index for query optimization
3. ‚úÖ Update integration tests to verify field exclusion

**Post-Fix Review:**
Once critical/high risks are mitigated, re-run risk assessment and gate decision.

---

**Report Generated:** 2025-10-01
**Next Review:** After critical fixes implemented
**Reviewer:** Quinn (Test Architect)
