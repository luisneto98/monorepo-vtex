# Story 3.7: Integração e Visualização de Informações do Evento

## Status
Ready for Review

## Story
**As a** visitante do aplicativo mobile,
**I want** visualizar informações detalhadas do evento (nome, datas, local, contatos, redes sociais),
**so that** possa ter acesso fácil a todas as informações importantes sobre o evento.

## Acceptance Criteria
1. Integração com endpoint `/api/event-settings` para buscar dados do evento
2. Exibição do nome do evento (multilíngue - pt/en/es) no header do app
3. Tela de "Sobre o Evento" acessível via tab "Mais" com informações completas:
   - Nome do evento (respeitando idioma do dispositivo)
   - Datas de início e fim formatadas
   - Local completo (nome do venue, endereço completo)
   - Mapa interativo com coordenadas do local
   - Informações de contato (email, telefone, WhatsApp)
   - Links para redes sociais (Instagram, Facebook, LinkedIn, Twitter, YouTube)
4. Cache local das informações do evento (TTL: 24 horas)
5. Atualização automática ao puxar para atualizar (pull-to-refresh)
6. Tratamento de erro quando informações não estiverem disponíveis

## Tasks / Subtasks

- [x] Task 1: Backend Integration Setup (AC: 1)
  - [x] Verify `/api/event-settings` endpoint is accessible (GET request)
  - [x] Create TypeScript interface for EventSettings matching backend DTO structure
  - [x] Add interface to `packages/shared/src/types/event-settings.ts`
  - [x] Create EventSettingsService in `apps/mobile/src/services/`
  - [x] Implement `fetchEventSettings()` method with error handling
  - [x] Add cache integration using existing CacheService (@cache_event_settings, TTL: 24h)

- [x] Task 2: Context and State Management (AC: 1, 4)
  - [x] Create EventSettingsContext in `apps/mobile/src/contexts/`
  - [x] Implement provider with state for event settings data
  - [x] Add loading, error, and data states
  - [x] Integrate with CacheService for persistence
  - [x] Create useEventSettings custom hook
  - [x] Implement refresh method for pull-to-refresh

- [x] Task 3: Event Name Display in Header (AC: 2)
  - [x] Update Home screen header to show event name
  - [x] Implement language detection (pt/en/es from device locale)
  - [x] Add fallback to Portuguese if locale not supported
  - [x] Handle loading state with skeleton loader
  - [x] Apply truncation for long event names

- [x] Task 4: Create "Sobre o Evento" Screen (AC: 3)
  - [x] Create AboutEventScreen in `apps/mobile/src/screens/AboutEvent/`
  - [x] Add route to AppNavigator
  - [x] Create menu item in MoreScreen
  - [x] Design layout with sections: Header, Dates, Venue, Map, Contact, Social Media
  - [x] Implement skeleton loading states
  - [x] Add error state with retry button

- [x] Task 5: Venue and Map Section (AC: 3)
  - [x] Create VenueSection component showing venue name and full address
  - [x] Integrate react-native-maps or use web view with Google Maps embed
  - [x] Display map marker at coordinates (latitude, longitude)
  - [x] Add "Abrir no Maps" button for native map app navigation
  - [x] Format address display (street, city, state, ZIP, complement)

- [x] Task 6: Contact Information Section (AC: 3)
  - [x] Create ContactSection component
  - [x] Display email with tap-to-email functionality (Linking.openURL)
  - [x] Display phone with tap-to-call functionality
  - [x] Display WhatsApp with tap-to-open WhatsApp functionality
  - [x] Add icons for each contact method
  - [x] Implement proper URL schemes (mailto:, tel:, whatsapp:)

- [x] Task 7: Social Media Links Section (AC: 3)
  - [x] Create SocialMediaSection component
  - [x] Display social media icons (Instagram, Facebook, LinkedIn, Twitter, YouTube)
  - [x] Implement tap handlers using Linking.openURL
  - [x] Show only available social media links (conditional rendering)
  - [x] Apply URL validation and sanitization (follow Story 3.4 security patterns)
  - [x] Use proper icons from icon library

- [x] Task 8: Cache and Refresh Logic (AC: 4, 5)
  - [x] Integrate CacheService for event settings storage
  - [x] Set cache key: @cache_event_settings with 24h TTL
  - [x] Implement stale-while-revalidate pattern
  - [x] Add pull-to-refresh on AboutEventScreen
  - [x] Show loading indicator during refresh
  - [x] Update timestamp of last fetch

- [x] Task 9: Error Handling and Edge Cases (AC: 6)
  - [x] Handle network errors gracefully
  - [x] Show error message when data cannot be fetched
  - [x] Implement retry button on error state
  - [x] Handle missing optional fields (complement, whatsapp, social media)
  - [x] Validate coordinates are within valid range (-90 to 90 lat, -180 to 180 lng)
  - [x] Add fallback for missing multilingual text fields

- [x] Task 10: Testing (All ACs)
  - [x] Write unit tests for EventSettingsService (8 tests minimum)
  - [x] Write tests for EventSettingsContext (6 tests minimum)
  - [x] Test language selection logic
  - [x] Test cache TTL and invalidation
  - [x] Test error states and retry logic
  - [x] Validate URL sanitization for external links
  - [x] Test pull-to-refresh functionality

## Dev Notes

### Previous Story Insights

#### Story 3.1 - Navigation and Infrastructure
- React Navigation configured with tab bar and stack navigation
- Deep linking setup with `vtexevents://` prefix
- AsyncStorage already integrated for local persistence
- Navigation structure: Home, Agenda, Buscar, Mais tabs
- More screen (MoreScreen.tsx) has menu items structure ready for additions
[Source: docs/stories/3.1.story.md#completion-notes]

#### Story 3.2 - Home Screen Components
- Pull-to-refresh pattern established across screens (RefreshControl)
- Skeleton loading components implemented
- Error state handling with retry functionality
- LazyImage component for optimized image loading
- Layout patterns for card-based content display
[Source: docs/stories/3.2.story.md#dev-notes]

#### Story 3.3 - Search and Filtering
- API service layer with 10-second timeout configured
- Retry logic with exponential backoff (3 retries: 1s, 2s, 4s)
- Cache strategy with TTL implemented for various data types
- Network error handling patterns established
- API base URL configuration in Constants
[Source: docs/stories/3.3.story.md#api-integration]

#### Story 3.4 - Deep Linking and Security
- Deep linking configured for `vtexevents://` scheme
- URL sanitization patterns for security (alphanumeric + hyphens only)
- React Native Linking API integrated for external URLs
- Social links validation with domain allowlist and HTTPS enforcement
- Security pattern: Validate all external URLs before opening
[Source: docs/stories/3.4.story.md#completion-notes]

#### Story 3.5 - FAQ and Recent Searches
- AsyncStorage patterns for persistent data
- Cache TTL of 5 minutes for frequently accessed data
- Pull-to-refresh implementation across list screens
- Context API for global state management (React Context)
[Source: docs/stories/3.5.story.md#dev-notes]

#### Story 3.6 - Push Notifications and Offline
- CacheService implemented with TTL-based caching (TTL in milliseconds)
- Cache keys follow pattern: `@cache_{dataType}`
- NetworkContext provides network state awareness
- Stale-while-revalidate pattern: show cached data immediately, fetch fresh in background
- Cache size management with LRU eviction
- Offline indicator component ready for reuse
[Source: docs/stories/3.6.story.md#completion-notes]

### Backend Integration Context

#### Story 2.7 - Admin Event Settings
The backend Event Settings module is already implemented and provides:
- **Endpoint**: `GET /api/event-settings`
- **Authentication**: Public endpoint (no auth required for visitor mode)
- **Response Structure**: Returns complete event configuration including:
  - Event name (multilingual: pt, en, es)
  - Start date and end date (ISO 8601 format)
  - Venue information (name, address, city, state, zipCode, complement)
  - Contact information (email, phone, whatsapp)
  - Social media links (instagram, facebook, linkedin, twitter, youtube)
  - Map coordinates (latitude, longitude with validation -90/90, -180/180)
[Source: apps/api/src/modules/event-settings/dto/create-event-settings.dto.ts]

### Data Models

#### EventSettings Interface
```typescript
interface MultilingualText {
  pt: string;
  en: string;
  es: string;
}

interface VenueInfo {
  name: string;
  address: string;
  city: string;
  state: string;
  zipCode: string;
  complement?: string; // Optional
}

interface ContactInfo {
  email: string; // Validated email format
  phone: string; // Format: +[country][number]
  whatsapp?: string; // Optional, same format as phone
}

interface SocialMediaLinks {
  instagram?: string; // Optional URL
  facebook?: string;
  linkedin?: string;
  twitter?: string;
  youtube?: string;
}

interface MapCoordinates {
  latitude: number; // -90 to 90
  longitude: number; // -180 to 180
}

interface EventSettings {
  eventName: MultilingualText;
  startDate: string; // ISO 8601 date-time string
  endDate: string; // ISO 8601 date-time string
  venue: VenueInfo;
  contact: ContactInfo;
  socialMedia?: SocialMediaLinks; // Optional
  mapCoordinates: MapCoordinates;
}
```

### API Specifications

#### Get Event Settings
- **Endpoint**: `GET /api/event-settings`
- **Auth**: Not required (public endpoint)
- **Response**: `EventSettings` object (200 OK)
- **Error Responses**:
  - 404 Not Found - Event settings not configured yet
  - 500 Internal Server Error - Server error
[Source: apps/api/src/modules/event-settings/event-settings.controller.ts]

### Component Specifications

#### File Locations
Based on existing mobile app structure:
- **Services**: `apps/mobile/src/services/EventSettingsService.ts`
- **Contexts**: `apps/mobile/src/contexts/EventSettingsContext.tsx`
- **Screens**: `apps/mobile/src/screens/AboutEvent/AboutEventScreen.tsx`
- **Components**: `apps/mobile/src/components/event/`
  - VenueSection.tsx
  - ContactSection.tsx
  - SocialMediaSection.tsx
  - EventDatesSection.tsx
- **Types**: `packages/shared/src/types/event-settings.ts` (already exists - reuse)
[Source: docs/architecture/unified-project-structure.md]

#### Component Design Patterns

**AboutEventScreen Layout:**
```
┌─────────────────────────────┐
│  [Header: Event Name]       │
├─────────────────────────────┤
│  📅 Datas                   │
│  25/09 - 27/09/2025         │
├─────────────────────────────┤
│  📍 Local                   │
│  Venue Name                 │
│  Full Address               │
│  [Ver no Mapa]              │
├─────────────────────────────┤
│  🗺️  Mapa                   │
│  [Interactive Map View]     │
├─────────────────────────────┤
│  📞 Contato                 │
│  📧 Email                   │
│  📱 Telefone                │
│  💬 WhatsApp                │
├─────────────────────────────┤
│  🌐 Redes Sociais           │
│  [Icons for available       │
│   social media links]       │
└─────────────────────────────┘
```

### Technical Constraints

#### Maps Integration
- Use **react-native-maps** for native map display (recommended)
  - Supports both iOS (Apple Maps) and Android (Google Maps)
  - Marker component for venue location
  - MapView with region prop for coordinates
  - Alternative: WebView with Google Maps Embed API for simpler setup
- **Linking API** for "Open in Maps" functionality
  - iOS: `maps://` or `http://maps.apple.com/`
  - Android: `geo:` or `https://maps.google.com/`
[Source: React Native documentation]

#### Date Formatting
- Use **date-fns** for date formatting (already in project dependencies)
- Format ISO 8601 strings to localized readable format
- Consider device locale for date format (DD/MM/YYYY for Brazil)
- Handle timezone differences appropriately
[Source: docs/architecture/tech-stack.md]

#### Language Detection
- Use `expo-localization` or `react-native-localize` for device locale
- Map locale to supported languages (pt, en, es)
- Default fallback: Portuguese (pt) if locale not supported
- Store selected language preference in AsyncStorage for consistency

#### External Links Security
- **Validate all URLs** before opening with Linking.openURL
- Follow Story 3.4 security patterns:
  - HTTPS enforcement for social media links
  - Domain allowlist for known social platforms
  - Sanitize URLs to prevent injection attacks
  - Handle deep links securely
[Source: docs/stories/3.4.story.md#security-fixes]

### Performance Optimizations

#### Cache Strategy
- **Cache Key**: `@cache_event_settings`
- **TTL**: 24 hours (86400000 ms) - event info changes infrequently
- **Pattern**: Stale-while-revalidate
  - Show cached data immediately on app open
  - Fetch fresh data in background
  - Update UI when fresh data arrives
- **Cache warming**: Fetch event settings on app launch (in EventSettingsProvider)
[Source: Story 3.6 CacheService patterns]

#### Network Optimization
- Fetch event settings only once on app launch
- Use cached data for subsequent views
- Manual refresh via pull-to-refresh
- No auto-refresh polling (data is relatively static)

#### Component Optimization
- Lazy load map component (only when AboutEventScreen is visible)
- Memoize formatted dates and addresses
- Conditional rendering for optional fields (whatsapp, social media, complement)

### Security Considerations

#### External URL Validation
Follow Story 3.4 security patterns:
```typescript
const ALLOWED_SOCIAL_DOMAINS = [
  'instagram.com',
  'facebook.com',
  'linkedin.com',
  'twitter.com',
  'youtube.com'
];

function isValidSocialMediaUrl(url: string, platform: string): boolean {
  // Validate HTTPS
  // Validate domain matches platform
  // Sanitize URL
  // Return boolean
}
```

#### Phone Number and Email Security
- **Phone numbers**: Validate format before opening tel: or whatsapp: URLs
- **Email**: Sanitize email addresses before mailto: links
- **Prevent injection**: Use URL encoding for all parameters

#### Map Coordinates Validation
- Validate latitude is between -90 and 90
- Validate longitude is between -180 and 180
- Provide fallback if coordinates are invalid (hide map, show address only)

### Testing Requirements

- **Test File Location**: `apps/mobile/tests/unit/services/EventSettingsService.test.ts`, `apps/mobile/tests/unit/contexts/EventSettingsContext.test.tsx`
- **Testing Frameworks**: Jest + React Native Testing Library
- **Coverage Target**: Minimum 60% overall, 80% for EventSettingsService

### Required Test Cases

1. **EventSettingsService**:
   - Fetch event settings success
   - Fetch event settings with network error
   - Cache hit returns cached data
   - Cache miss triggers API call
   - TTL expiry triggers refetch
   - Handles 404 response gracefully
   - Language selection logic (pt/en/es)

2. **EventSettingsContext**:
   - Provider initializes with loading state
   - Data loads successfully and updates state
   - Error state handled correctly
   - Refresh method clears cache and refetches
   - useEventSettings hook provides correct data
   - Context throws error when used outside provider

3. **Component Tests**:
   - AboutEventScreen renders all sections correctly
   - Conditional rendering for optional fields (whatsapp, social media)
   - Pull-to-refresh triggers data refresh
   - Error state shows retry button
   - Linking.openURL called with correct URLs

4. **Security Tests**:
   - Social media URLs validated before opening
   - Invalid URLs are rejected
   - Phone number format validation
   - Map coordinates validation

### Accessibility Considerations

#### Screen Readers
```typescript
// Event Name Header
accessibilityRole="header"
accessibilityLabel={`Evento: ${eventName}`}

// Contact Buttons
accessibilityRole="button"
accessibilityLabel="Enviar email para contato"
accessibilityHint="Abre o aplicativo de email"

// Social Media Links
accessibilityRole="link"
accessibilityLabel={`Abrir ${platform} do evento`}

// Map View
accessibilityLabel="Mapa da localização do evento"
accessibilityHint="Use os botões abaixo para abrir no aplicativo de mapas"
```

#### High Contrast Support
- Ensure contact icons have sufficient contrast (WCAG AA: 4.5:1)
- Map marker should be visible in both light and dark modes
- Social media icons should support dark mode

### Project Structure Notes

The mobile app follows the established structure from Stories 3.1-3.6:
- Services layer for API calls and business logic
- Context API for global state (EventSettingsContext)
- Reusable components in `components/` folder
- Screen-specific components in `screens/` folder
- AsyncStorage via CacheService for all local persistence
- React Navigation for routing and deep linking integration

All new code should follow existing patterns from previous stories:
- Use TypeScript interfaces from `packages/shared/src/types/`
- Follow error handling patterns from Story 3.3 (retry logic, timeouts)
- Use skeleton loaders from Story 3.2 for loading states
- Apply security patterns from Story 3.4 (URL validation, sanitization)
- Implement cache patterns from Story 3.6 (CacheService, TTL, stale-while-revalidate)

## Testing

### Test File Locations
- **Unit Tests**: `apps/mobile/tests/unit/services/EventSettingsService.test.ts`
- **Context Tests**: `apps/mobile/tests/unit/contexts/EventSettingsContext.test.tsx`
- **Component Tests**: `apps/mobile/tests/unit/components/event/` for VenueSection, ContactSection, SocialMediaSection

### Testing Frameworks
- **Jest**: Unit testing framework (already configured)
- **React Native Testing Library**: Component testing
- **@testing-library/react-hooks**: Hook testing for custom hooks

### Testing Standards
- Minimum 60% overall test coverage for the story
- 80% coverage target for EventSettingsService
- Test all critical paths: data fetching, caching, error handling, URL validation
- Mock AsyncStorage, fetch API, and Linking API in tests
- Test language selection logic
- Validate accessibility attributes in component tests

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Story created based on existing event-settings backend and mobile app patterns | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
No critical debugging required. All implementation proceeded smoothly following established patterns from previous stories.

### Completion Notes List
- Successfully integrated EventSettings API with stale-while-revalidate caching pattern
- Implemented multilingual event name display in Home screen header with device locale detection
- Created comprehensive "Sobre o Evento" screen with all required sections
- Applied Story 3.4 security patterns for URL validation (HTTPS enforcement, domain allowlist)
- VenueSection uses native Maps linking (Apple Maps for iOS, Google Maps for Android)
- ContactSection handles optional WhatsApp field and provides fallback to web version if app not installed
- SocialMediaSection conditionally renders only available platforms with full URL validation
- All components follow accessibility best practices with proper roles, labels, and hints
- Comprehensive test coverage: 34 tests total (26 for EventSettingsService, 8 for EventSettingsContext)
- Cache TTL set to 24 hours as specified, with background refresh on cache hits
- Error handling covers network errors (NETWORK_ERROR), 404 (NOT_FOUND), 500+ (SERVER_ERROR)
- Coordinate validation ensures latitude (-90 to 90) and longitude (-180 to 180) are within valid ranges
- Added date-fns and expo-localization dependencies to package.json
- EventSettingsProvider wrapped in App.tsx context hierarchy

### File List
**New Files:**
- `apps/mobile/src/services/EventSettingsService.ts` - Service layer for API calls and caching
- `apps/mobile/src/contexts/EventSettingsContext.tsx` - Global state management with React Context
- `apps/mobile/src/components/event/EventDatesSection.tsx` - Event dates display component
- `apps/mobile/src/components/event/VenueSection.tsx` - Venue info with Maps integration
- `apps/mobile/src/components/event/ContactSection.tsx` - Contact information with tap-to-action
- `apps/mobile/src/components/event/SocialMediaSection.tsx` - Social media links with URL validation
- `apps/mobile/src/screens/AboutEvent/AboutEventScreen.tsx` - Main "Sobre o Evento" screen
- `apps/mobile/tests/unit/services/EventSettingsService.test.ts` - 26 unit tests for service
- `apps/mobile/tests/unit/contexts/EventSettingsContext.test.tsx` - 8 unit tests for context

**Modified Files:**
- `apps/mobile/src/screens/Home/HomeScreen.tsx` - Added event name display in header
- `apps/mobile/src/navigation/AppNavigator.tsx` - Added AboutEvent route
- `apps/mobile/src/screens/More/MoreScreen.tsx` - Added "Sobre o Evento" menu item
- `apps/mobile/App.tsx` - Wrapped app with EventSettingsProvider
- `apps/mobile/src/services/CacheService.ts` - Added EVENT_SETTINGS cache config
- `apps/mobile/package.json` - Added date-fns and expo-localization dependencies
- `packages/shared/src/types/event-settings.ts` - Already existed, reused without modification

## QA Results
_To be populated by QA agent_