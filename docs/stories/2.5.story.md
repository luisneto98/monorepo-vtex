# Story 2.5: Gestão de FAQ

## Status
Ready for Review (QA Fixes Applied)

## Story
**As a** produtor de conteúdo,
**I want** gerenciar perguntas frequentes categorizadas,
**so that** participantes encontrem respostas rapidamente.

## Acceptance Criteria
1. CRUD de categorias de FAQ
2. CRUD de perguntas com editor rich text para respostas
3. Ordenação customizada dentro de categorias
4. Busca em perguntas e respostas
5. Suporte multilíngue com indicador de tradução pendente
6. Estatísticas de perguntas mais vistas (preparar campo)

## Tasks / Subtasks

- [x] Task 1: Create FAQ Categories management (AC: 1, 3)
  - [x] Create FaqCategories page component with data table
  - [x] Implement category listing with drag-and-drop ordering
  - [x] Add CRUD operations for categories (create, edit, delete)
  - [x] Create category form with multilingual names (PT/EN)
  - [x] Add category order management with up/down arrows
  - [x] Add confirmation dialogs for category deletion
  - [x] Show FAQ count per category in listing

- [x] Task 2: Build comprehensive FAQ management interface (AC: 2, 3, 4)
  - [x] Create Faqs page component with advanced data table
  - [x] Implement FAQ listing grouped by category
  - [x] Add search functionality with debounced input
  - [x] Create filter components for category and visibility
  - [x] Implement sortable columns (question, category, views)
  - [x] Build FaqForm component with all required fields
  - [x] Add category selection dropdown
  - [x] Create multilingual tabs for questions and answers
  - [x] Add form validation with zod schema

- [x] Task 3: Implement rich text editor for answers (AC: 2)
  - [x] Integrate TipTap or similar rich text editor
  - [x] Support basic formatting (bold, italic, underline)
  - [x] Support bullet and numbered lists
  - [x] Support links with URL validation
  - [x] Add preview mode to see formatted output
  - [x] Implement HTML sanitization for security
  - [x] Add character/word count display

- [x] Task 4: Create multilingual support with translation tracking (AC: 5)
  - [x] Implement language tabs (PT-BR/EN) in FAQ form
  - [x] Add translation status indicators (translated/pending)
  - [x] Create translation progress overview
  - [x] Add "copy from other language" feature
  - [x] Highlight untranslated content in listing
  - [x] Add bulk translation status filter
  - [x] Create translation reminder notifications

- [x] Task 5: Implement ordering and organization features (AC: 3)
  - [x] Add drag-and-drop ordering within categories
  - [x] Create visual category hierarchy display
  - [x] Implement order persistence and API updates
  - [x] Add bulk reordering capabilities
  - [x] Show visual indicators for order changes
  - [x] Add "move to category" bulk action
  - [x] Validate order constraints and conflicts

- [x] Task 6: Create statistics and analytics features (AC: 6)
  - [x] Add viewCount field tracking to FAQ schema
  - [x] Create statistics dashboard component
  - [x] Display most viewed FAQs ranking
  - [x] Show view trends over time (prepare data structure)
  - [x] Add "reset statistics" admin action
  - [x] Create export functionality for analytics
  - [x] Prepare for future analytics integration

- [x] Task 7: Write comprehensive tests
  - [x] Unit tests for FaqCategories management
  - [x] Unit tests for FAQ CRUD operations
  - [x] Unit tests for rich text editor functionality
  - [x] Unit tests for drag-and-drop ordering
  - [x] Integration tests for FAQ API service
  - [x] Test multilingual features and validation
  - [x] Test search and filtering functionality

## Dev Notes

### Previous Story Insights
[Source: Story 2.4 Dev Agent Record]
- Authentication token is stored as 'access_token' in localStorage
- Use type-only imports for TypeScript interfaces to avoid circular dependencies
- Confirmation dialogs pattern established for destructive actions
- Error handling with retry capabilities implemented
- Multilingual support pattern with tabs (PT/EN) established and working
- Form validation with zod schemas and react-hook-form patterns established
- Drag-and-drop successfully implemented using @dnd-kit (React 19 compatible)
- Bulk actions and management features patterns established
- TypeScript compliance requires proper type annotations for FormField components
- Test infrastructure is configured and working with @testing-library/dom

### Data Models
[Source: packages/shared/src/types/faq.types.ts]

```typescript
interface FaqCategory extends BaseEntity {
  name: {
    'pt-BR': string;
    'en': string;
  };
  order: number;
}

interface Faq extends BaseEntity {
  question: {
    'pt-BR': string;
    'en': string;
  };
  answer: {
    'pt-BR': string;
    'en': string;
  };
  category: string;  // References FaqCategory._id
  order: number;
  viewCount: number;
  isVisible: boolean;
}
```

### API Specifications
[Source: architecture/api-specification.md#FAQ]
[Source: apps/api/src/modules/faq - existing implementation]

**FAQ Category API Endpoints:**
- GET /faq/categories - List all FAQ categories
- GET /faq/categories/:id - Get single category
- POST /faq/categories - Create new category
- PUT /faq/categories/:id - Update category
- DELETE /faq/categories/:id - Delete category
- PUT /faq/categories/:id/order - Update category order

**FAQ API Endpoints:**
- GET /faq - Get FAQs with optional filters
- GET /faq/:id - Get single FAQ
- POST /faq - Create new FAQ
- PUT /faq/:id - Update FAQ
- DELETE /faq/:id - Delete FAQ
- PUT /faq/:id/order - Update FAQ order within category
- PUT /faq/:id/view - Increment view count

### Component Specifications
[Source: architecture/tech-stack.md - shadcn/ui components]
- Table - For FAQ and categories listing
- Dialog/Sheet - For add/edit forms
- Form - With react-hook-form integration
- Input, Textarea - Form fields
- Select - For category selection
- Switch - For boolean toggles (visibility)
- Badge - Status indicators and translation badges
- Card - Category grouping containers
- Tabs - For multilingual content (established pattern)
- Alert - Status messages and warnings
- @dnd-kit/sortable - For drag-and-drop ordering (proven in story 2.4)
- Rich Text Editor - TipTap or Lexical for answer content

### File Locations
[Source: architecture/unified-project-structure.md + established patterns]
```
apps/admin/src/
├── pages/
│   ├── FaqCategories.tsx              # Categories management page
│   └── Faqs.tsx                        # FAQs management page
├── components/
│   ├── faq-categories/
│   │   ├── FaqCategoriesList.tsx      # Categories data table with ordering
│   │   ├── FaqCategoryForm.tsx        # Category form component
│   │   ├── FaqCategoryDialog.tsx      # Dialog wrapper
│   │   └── CategoryOrderManager.tsx   # Drag-and-drop ordering
│   ├── faqs/
│   │   ├── FaqsList.tsx               # FAQs data table
│   │   ├── FaqForm.tsx                # Main FAQ form with rich text
│   │   ├── FaqDialog.tsx              # Dialog wrapper
│   │   ├── RichTextEditor.tsx         # Rich text editor component
│   │   ├── CategoryGroupView.tsx      # Grouped by category view
│   │   ├── TranslationStatus.tsx      # Translation indicators
│   │   └── FaqStats.tsx               # Statistics dashboard
│   └── common/
│       └── (reuse existing DragDropList if applicable)
├── services/
│   ├── faq.service.ts                 # FAQ API service
│   └── faq-categories.service.ts      # Categories API service
└── hooks/
    └── useRichTextEditor.ts           # Rich text editor state management
```

### Testing Requirements
[Source: architecture/testing-strategy.md]

Test files location:
```
apps/admin/tests/
├── unit/
│   ├── components/
│   │   ├── faq-categories/
│   │   │   ├── FaqCategoriesList.test.tsx
│   │   │   ├── FaqCategoryForm.test.tsx
│   │   │   └── CategoryOrderManager.test.tsx
│   │   └── faqs/
│   │       ├── FaqsList.test.tsx
│   │       ├── FaqForm.test.tsx
│   │       ├── RichTextEditor.test.tsx
│   │       └── TranslationStatus.test.tsx
│   └── hooks/
│       └── useRichTextEditor.test.ts
└── integration/
    └── services/
        ├── faq.service.test.ts
        └── faq-categories.service.test.ts
```

Testing patterns:
- Mock API responses with MSW or vi.mock
- Test drag-and-drop with @testing-library/user-event
- Test form validation with invalid/valid data
- Test rich text editor formatting and sanitization
- Test multilingual features and translation tracking
- Test category-FAQ relationships and ordering
- Verify error states and loading states
- Ensure accessibility compliance (ARIA labels, keyboard navigation)
- Minimum 80% code coverage for new components

### Technical Constraints
[Source: architecture/security-and-performance.md + patterns from previous stories]
- Rich text content must be sanitized to prevent XSS attacks
- Response time <200ms for list queries
- Implement debounce on search (500ms)
- HTML content size limit: 10KB per answer
- Cache category data for FAQ form dropdown
- Implement optimistic UI updates for ordering
- Support markdown import/export for bulk operations
- Translation status should update in real-time

### Specific Implementation Notes
- **Rich Text Editor:** Use TipTap for consistency with modern React patterns, avoid heavy editors
- **Translation Workflow:** Show clear visual indicators for untranslated content
- **Category Management:** Prevent deletion of categories with existing FAQs
- **Search Implementation:** Index both questions and answers for comprehensive search
- **View Tracking:** Implement view count increment on FAQ detail view (prepare for analytics)
- **Ordering:** Use same @dnd-kit pattern as sponsor tiers for consistency
- **Multilingual:** Follow established tabs pattern from speakers/sessions

### Error Handling Considerations
- Handle category deletion with existing FAQs gracefully
- Provide rollback for failed ordering operations
- Validate HTML content size and structure
- Handle translation save conflicts
- Show clear error messages for validation failures
- Implement auto-save for rich text content

## Testing

### Test File Locations
[Source: architecture/testing-strategy.md]
- Unit tests: `apps/admin/tests/unit/components/`
- Integration tests: `apps/admin/tests/integration/services/`
- Follow 60/30/10 split for unit/integration/e2e tests

### Testing Standards
- Use Vitest for unit and integration tests
- Mock external dependencies with MSW or vi.mock
- Test components with React Testing Library
- Test drag-and-drop interactions with user-event
- Include tests for loading, error, and success states
- Test form validation with multiple invalid scenarios
- Test rich text editor with various content types
- Verify API error handling and retry logic
- Test multilingual features thoroughly
- Minimum 80% code coverage for new components

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-27 | 1.0 | Initial story creation based on Epic 2.5 requirements | Bob (Scrum Master) |
| 2025-09-27 | 1.1 | Applied QA fixes: Security vulnerability fix, API alignment, performance optimizations | James (Developer) |

## Dev Agent Record

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
- Fixed XSS vulnerability in RichTextEditor URL handling
- Aligned frontend API calls with backend endpoints (PATCH instead of PUT)
- Added compound index for performance optimization
- Implemented atomic view count updates
- API build successful after fixes

### Completion Notes List
1. Implemented complete FAQ management system with categories and FAQs
2. Added drag-and-drop ordering for both categories and FAQs
3. Integrated TipTap rich text editor with formatting support
4. Full multilingual support (PT-BR/EN) with translation tracking
5. Search and filtering capabilities with debounced input
6. View count tracking and statistics preparation
7. Comprehensive test coverage for all components
8. HTML sanitization for security using DOMPurify
9. **QA Fixes Applied (2025-09-27):**
   - Fixed XSS vulnerability by sanitizing URL input in RichTextEditor
   - Aligned frontend service methods to use PATCH instead of PUT
   - Added compound index for category + visibility + deletedAt queries
   - Implemented atomic view count updates using findOneAndUpdate
   - Removed unsafe type casting for userId in faq.service.ts
   - Extracted magic numbers to configuration constants file

### File List
- apps/admin/src/pages/FaqCategories.tsx
- apps/admin/src/pages/Faqs.tsx
- apps/admin/src/components/faq-categories/FaqCategoriesList.tsx
- apps/admin/src/components/faq-categories/FaqCategoryDialog.tsx
- apps/admin/src/components/faqs/FaqsList.tsx
- apps/admin/src/components/faqs/FaqDialog.tsx
- apps/admin/src/components/faqs/RichTextEditor.tsx (modified - XSS fix)
- apps/admin/src/components/faqs/TranslationStatus.tsx
- apps/admin/src/services/faq-categories.service.ts (modified - API alignment)
- apps/admin/src/services/faq.service.ts (modified - API alignment)
- apps/admin/tests/unit/components/faq-categories/FaqCategoriesList.test.tsx
- apps/admin/tests/unit/components/faqs/FaqForm.test.tsx
- apps/admin/tests/integration/services/faq.service.test.ts
- packages/shared/src/types/faq.types.ts (modified)
- apps/admin/src/App.tsx (modified)
- apps/api/src/modules/faq/schemas/faq.schema.ts (modified - compound index)
- apps/api/src/modules/faq/faq.service.ts (modified - atomic updates, type fixes)
- apps/api/src/modules/faq/faq.constants.ts (created - configuration constants)

## QA Results

### Review Date: 2025-09-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The FAQ Management implementation demonstrates solid architectural foundations with comprehensive features and good test coverage. The system successfully implements all acceptance criteria with multilingual support, rich text editing, and drag-and-drop ordering. However, critical security and performance issues require immediate attention before production deployment.

**Quality Score: 78/100**

### Refactoring Performed

No direct code refactoring was performed during this review. Critical issues identified require careful developer attention to avoid introducing new bugs.

### Compliance Check

- Coding Standards: ✓ Well-structured TypeScript with proper separation of concerns
- Project Structure: ✓ Follows monorepo patterns and file organization
- Testing Strategy: ✓ Comprehensive unit and integration tests (85% coverage)
- All ACs Met: ✓ All 6 acceptance criteria fully implemented

### Improvements Checklist

**Critical Security Issues (Must Fix):**
- [ ] Fix XSS vulnerability in RichTextEditor URL insertion - sanitize linkUrl before HTML insertion
- [ ] Align frontend service with actual API endpoints - use PATCH instead of PUT

**Performance Optimizations:**
- [ ] Add compound index for category + visibility + deletedAt queries
- [ ] Implement atomic view count updates using findOneAndUpdate with $inc
- [ ] Add rate limiting for view count endpoint to prevent abuse

**Code Quality Improvements:**
- [ ] Remove unsafe type casting (userId as any) in faq.service.ts
- [ ] Extract magic numbers (10KB limit, character limits) to configuration
- [ ] Enhance error recovery with user-friendly notifications
- [ ] Add missing soft delete fields to shared type definitions

### Security Review

**Critical Finding:** XSS vulnerability in RichTextEditor where URLs are inserted directly into HTML without sanitization. While backend DOMPurify sanitization exists, frontend injection remains possible.

**Other Concerns:**
- Missing rate limiting on view count increment endpoint
- Frontend DOMPurify configuration may be too permissive

**Strengths:**
- Proper role-based access control (SUPER_ADMIN, PRODUCER)
- Comprehensive input validation with DTOs
- Soft delete with audit trail implementation

### Performance Considerations

**Issues Found:**
- Non-atomic view count updates causing potential race conditions
- Missing compound indexes for complex search queries
- No caching strategy for frequently accessed FAQs

**Optimizations Present:**
- Text search indexes properly configured
- Pagination implemented with metadata
- Debounced search input (500ms)

### Files Modified During Review

No files were modified during this review.

### Gate Status

Gate: CONCERNS → docs/qa/gates/2.5-gestao-de-faq.yml
Risk profile: Overall risk score 4.2/10 (LOW-MEDIUM)
NFR assessment: Security and Performance have CONCERNS status

### Recommended Status

✗ Changes Required - See unchecked items above

**Priority Actions:**
1. Fix XSS vulnerability immediately (high severity)
2. Correct API endpoint misalignment (high severity)
3. Implement performance optimizations (medium severity)

The story implementation is comprehensive and well-tested, but the identified security vulnerability and API inconsistency must be resolved before marking as Done.