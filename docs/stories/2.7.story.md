# Story 2.7: Push Notifications

## Status
APPROVED

## Story
**As a** administrador,
**I want** enviar notificações para os apps,
**so that** possa comunicar mudanças importantes.

## Acceptance Criteria
1. Interface para criar e enviar notificações
2. Preview de como aparecerá no dispositivo
3. Agendamento de envio futuro
4. Histórico de notificações enviadas
5. Contador de dispositivos alcançados
6. Teste de envio para dispositivo específico

## Tasks / Subtasks

- [ ] Task 1: Extend Notifications Backend Module (AC: 1, 3, 4, 5, 6)
  - [ ] Add Notification schema to MongoDB with fields: title, message, scheduledAt, sentAt, deviceCount, status, createdBy
  - [ ] Create DTOs for CreateNotificationDto and UpdateNotificationDto with validation
  - [ ] Extend notifications.service.ts with methods for CRUD operations
  - [ ] Add endpoint for scheduling notifications (POST /notifications/schedule)
  - [ ] Create endpoint to get notifications history (GET /notifications/history)
  - [ ] Implement device registration endpoint (POST /notifications/devices/register)
  - [ ] Add endpoint for test notification to specific device (POST /notifications/test)
  - [ ] Implement job queue for scheduled notifications using Bull
  - [ ] Add pagination and filtering for notifications history
  - [ ] Create metrics tracking for delivered/failed notifications

- [ ] Task 2: Build Push Notifications Admin Interface (AC: 1, 2)
  - [ ] Create PushNotifications page component in apps/admin/src/pages/
  - [ ] Build notification composer form with title and message fields
  - [ ] Add rich text editor for message formatting (basic: bold, italic, links)
  - [ ] Implement device preview component showing iOS/Android notification appearance
  - [ ] Create segmentation options (all users, by role, by event attendance)
  - [ ] Add character counter for title (max 65) and message (max 240)
  - [ ] Implement form validation with error messages
  - [ ] Add confirmation dialog before sending
  - [ ] Create loading states and success/error notifications

- [ ] Task 3: Implement Notification Scheduling (AC: 3)
  - [ ] Add date/time picker component to notification form
  - [ ] Create timezone selector with user's local time display
  - [ ] Implement scheduled notifications queue viewer
  - [ ] Add ability to edit/cancel scheduled notifications
  - [ ] Create visual indicator for scheduled vs sent notifications
  - [ ] Add validation to prevent scheduling in the past
  - [ ] Implement recurring notification options (daily, before each session)

- [ ] Task 4: Create Notifications History View (AC: 4, 5)
  - [ ] Build NotificationHistory component with table/list view
  - [ ] Display sent notifications with timestamp, sender, title, message
  - [ ] Add device reach counter showing delivery statistics
  - [ ] Implement filtering by date range, status, sender
  - [ ] Add search functionality for notification content
  - [ ] Create pagination for large history lists
  - [ ] Add export functionality (CSV/Excel) for reporting
  - [ ] Show delivery status: pending, sent, failed with retry counts

- [ ] Task 5: Implement Test Notification Feature (AC: 6)
  - [ ] Create test device registration flow in admin
  - [ ] Add "Send Test" button in notification composer
  - [ ] Build device selector dropdown for registered test devices
  - [ ] Implement immediate test notification delivery
  - [ ] Add test notification indicator/badge in preview
  - [ ] Create feedback mechanism to confirm delivery
  - [ ] Log test notifications separately from production sends

- [ ] Task 6: Mobile App Integration Preparation
  - [ ] Document FCM/APNS setup requirements for mobile team
  - [ ] Define notification payload structure and types
  - [ ] Create notification click action handlers specification
  - [ ] Add deep linking support for notification actions
  - [ ] Implement notification preferences API for users
  - [ ] Create unsubscribe mechanism and compliance with regulations

- [ ] Task 7: Testing and Monitoring
  - [ ] Write unit tests for notification service methods
  - [ ] Create integration tests for scheduling and delivery
  - [ ] Add E2E tests for admin interface workflows
  - [ ] Implement monitoring for notification delivery rates
  - [ ] Add alerting for failed notification batches
  - [ ] Create performance tests for bulk notifications
  - [ ] Test timezone handling across different regions

## Dev Notes

### Previous Story Insights
Story 2.6 (Controle de Visibilidade) established the system configuration pattern and admin interface patterns that should be followed:
- System configuration stored in MongoDB with caching via Redis for immediate application
- Admin interface built with React, Tailwind CSS, and shadcn/ui components
- Real-time updates without requiring deployment
- Audit trail for all administrative changes
[Source: 2.6.story.md completion notes]

### Data Models
The notification system will need the following schema structure:
```typescript
interface Notification {
  _id: ObjectId;
  title: string; // Max 65 characters
  message: string; // Max 240 characters
  scheduledAt?: Date; // Optional for scheduled sends
  sentAt?: Date; // Actual send timestamp
  status: 'draft' | 'scheduled' | 'sending' | 'sent' | 'failed';
  deviceCount: number; // Number of devices targeted
  deliveredCount?: number; // Actual delivery count
  failedCount?: number; // Failed delivery count
  createdBy: ObjectId; // Reference to User
  segments?: string[]; // Target segments
  metadata?: Record<string, any>; // Additional data
  createdAt: Date;
  updatedAt: Date;
}

interface DeviceToken {
  _id: ObjectId;
  userId?: ObjectId; // Optional user reference
  token: string; // FCM or APNS token
  platform: 'ios' | 'android' | 'web';
  appVersion?: string;
  lastActive: Date;
  isTestDevice: boolean;
  createdAt: Date;
  updatedAt: Date;
}
```
[Source: Based on architecture/data-models.md patterns]

### API Specifications
Existing notifications module at `apps/api/src/modules/notifications/` needs extension:
- Current endpoints: POST /notifications/broadcast, POST /notifications/session-reminder
- New endpoints needed:
  - POST /notifications/schedule - Schedule future notification
  - GET /notifications/history - Get sent notifications with pagination
  - POST /notifications/devices/register - Register device token
  - POST /notifications/test - Send test to specific device
  - GET /notifications/scheduled - View scheduled notifications
  - DELETE /notifications/:id - Cancel scheduled notification
  - GET /notifications/stats - Delivery statistics

All endpoints require authentication with JwtAuthGuard and role-based access (SUPER_ADMIN, PRODUCER)
[Source: apps/api/src/modules/notifications/notifications.controller.ts]

### Component Specifications
Admin interface components following existing patterns:
- Location: `apps/admin/src/pages/PushNotifications.tsx`
- Use existing UI components from shadcn/ui (Button, Card, Form, Table, Dialog)
- Follow the same layout pattern as other admin pages (sidebar navigation, header, content area)
- Use React Hook Form for form management
- Use React Query for API calls
- Implement optimistic updates for better UX
[Source: architecture/frontend-architecture.md, apps/admin patterns]

### File Locations
Based on project structure:
- Backend: `apps/api/src/modules/notifications/`
  - schemas/notification.schema.ts
  - dto/create-notification.dto.ts
  - dto/update-notification.dto.ts
  - notifications.service.ts (extend existing)
  - notifications.controller.ts (extend existing)
- Admin Frontend: `apps/admin/src/`
  - pages/PushNotifications.tsx
  - components/notifications/NotificationComposer.tsx
  - components/notifications/NotificationPreview.tsx
  - components/notifications/NotificationHistory.tsx
  - services/notificationsService.ts
[Source: architecture/unified-project-structure.md]

### Testing Requirements
- Unit tests: 80% coverage for service methods
- Integration tests: Test notification scheduling and delivery flow
- E2E tests: Test complete workflow from admin UI to notification creation
- Performance tests: Ensure system can handle 10,000+ device notifications
- Test files location:
  - Backend: `apps/api/tests/unit/modules/notifications/`
  - Admin: `apps/admin/tests/`
[Source: architecture/testing-strategy.md]

### Technical Constraints
- Use Bull queue for job scheduling (already in tech stack for background jobs)
- Implement rate limiting to prevent notification spam
- Character limits: Title (65), Message (240) for mobile compatibility
- Support timezone handling for global events
- Implement retry logic for failed deliveries (max 3 retries)
- Cache notification templates for frequently used messages
- Use Redis for device token caching to improve performance
[Source: architecture/tech-stack.md, performance requirements]

### Security Considerations
- Validate and sanitize all notification content to prevent XSS
- Implement rate limiting per admin user (max 10 notifications per hour)
- Log all notification sends in audit trail
- Encrypt device tokens at rest
- Implement GDPR compliance for notification preferences
- Add unsubscribe mechanism in all notifications
[Source: architecture/security-best-practices.md patterns]

### Project Structure Notes
The notifications module already exists but needs significant extension. The current implementation only has basic broadcast functionality. This story will transform it into a full-featured push notification system with scheduling, history, and device management capabilities.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-11-17 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*(To be filled by the development agent)*

## QA Results
*(To be filled by the QA agent)*